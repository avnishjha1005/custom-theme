{% comment %}
  Mobile Tab Bar - Figma Tab-Path Version
{% endcomment %}

{% liquid
  assign menu = section.settings.menu
  assign drawer_menu = section.settings.drawer_menu
  assign tab_bar_variant = section.settings.mobile_tab_bar_variant | default: 'solid'
  assign show_on_tablet = section.settings.mobile_tab_bar_show_on_tablet
%}

<div class="mobile-tab-bar-wrapper" data-section-id="{{ section.id }}">
  
  {% comment %} Mobile Menu Drawer (Slides Up) {% endcomment %}
  <div class="mobile-tab-bar__drawer-container" data-drawer-container>
    <div class="mobile-tab-bar__drawer-overlay" data-drawer-overlay></div>
    <div class="mobile-tab-bar__drawer" id="mobile-drawer" data-drawer role="dialog">
      
      <div class="mobile-tab-bar__drawer-header">
        <div class="drawer-header-actions">
           <button class="drawer-back-btn is-hidden" data-drawer-back aria-label="Back">
             <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="1.2"><polyline points="15 18 9 12 15 6"></polyline></svg>
          </button>
          <button class="mobile-tab-bar__drawer-close" data-drawer-close>
            <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="1.2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
          </button>
        </div>

        {% comment %} Level 1 Tabs - These will update their text when drilling down {% endcomment %}
        <div class="drawer-l1-nav">
          <div class="l1-nav-inner" data-l1-container>
            {% for link in drawer_menu.links %}
              <button type="button" 
                class="l1-nav-item {% if forloop.first %}is-active{% endif %}" 
                data-l1-id="{{ forloop.index }}"
                data-original-title="{{ link.title}}">
                {{ link.title}}
              </button>
            {% endfor %}
          </div>
        </div>
      </div>

      <div class="mobile-tab-bar__drawer-content" data-drawer-panels>
        {% for l1_link in drawer_menu.links %}
          <div class="drawer-panel {% if forloop.first %}is-active{% endif %}" data-panel-l1="{{ forloop.index }}">
            
            {% comment %} Level 2 List {% endcomment %}
            <ul class="drawer-links-list" data-level="2">
              {% for l2_link in l1_link.links %}
                <li class="drawer-item-container">
                  <button type="button" class="drawer-link-btn" 
                    {% if l2_link.links.size > 0 %}data-drill-down{% endif %}
                    {% if l2_link.links.size == 0 %}onclick="window.location.href='{{ l2_link.url }}'"{% endif %}
                    data-target="l3-{{ forloop.parentloop.index }}-{{ forloop.index }}"
                    data-path="{{ l1_link.title}} / {{ l2_link.title }}">
                    {{ l2_link.title }}
                    {% if l2_link.links.size > 0 %}
                      <span class="arrow-icon">
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.2"><polyline points="9 18 15 12 9 6"></polyline></svg>
                      </span>
                    {% endif %}
                  </button>
                  
                  {% comment %} Level 3 Nested Panel {% endcomment %}
                  {% if l2_link.links.size > 0 %}
                    <div class="drawer-panel-nested" id="l3-{{ forloop.parentloop.index }}-{{ forloop.index }}">
                      <ul class="drawer-links-list" data-level="3">
                        {% for l3_link in l2_link.links %}
                          <li>
                            <a href="{{ l3_link.url }}" class="drawer-link-btn">
                              {{ l3_link.title }}
                            </a>
                          </li>
                        {% endfor %}
                      </ul>
                    </div>
                  {% endif %}
                </li>
              {% endfor %}
            </ul>
          </div>
        {% endfor %}
      </div>

      <div class="drawer-footer">
        <span>INDIA (INR)</span>
        <a href="/pages/contact">CONTACT US</a>
      </div>
    </div>
  </div>

  {% comment %} Bottom Tab Bar (Icons Only) {% endcomment %}
  <nav class="mobile-tab-bar">
    <div class="mobile-tab-bar__container">
      {% for link in menu.links %}
        {% liquid
          assign title = link.title | downcase
          assign is_menu = false
          if link.url contains '#menu' or title contains 'menu'
            assign is_menu = true
          endif
        %}
        <button type="button" class="mobile-tab-bar__item" {% if is_menu %}data-drawer-trigger{% endif %} {% unless is_menu %}onclick="window.location.href='{{ link.url }}'"{% endunless %}>
          <span class="mobile-tab-bar__icon">
            {% if title contains 'search' %}
              {{- 'icon-search.svg' | inline_asset_content -}}
            {% elsif title contains 'cart' %}
              {{- 'icon-cart.svg' | inline_asset_content -}}
            {% elsif title contains 'account' or  title contains 'login' %}{{- 'icon-account.svg' | inline_asset_content -}}
            {% else %}{{- 'icon-menu.svg' | inline_asset_content -}}
            {% endif %}
          </span>
        </button>
      {% endfor %}
    </div>
  </nav>
</div>

<script>
  function initMobileMenu() {
    const section = document.querySelector('[data-section-id="{{ section.id }}"]');
    if(!section) return;

    const drawer = section.querySelector('[data-drawer-container]');
    const l1Btns = section.querySelectorAll('[data-l1-id]');
    const drillBtns = section.querySelectorAll('[data-drill-down]');
    const backBtn = section.querySelector('[data-drawer-back]');
    const panels = section.querySelectorAll('.drawer-panel');

    // Handle Level 1 Tab Swaps
    l1Btns.forEach(btn => {
      btn.onclick = () => {
        l1Btns.forEach(b => {
          b.classList.remove('is-active');
          b.innerText = b.dataset.originalTitle; // Reset other tabs text
        });
        btn.classList.add('is-active');
        
        panels.forEach(p => p.classList.remove('is-active'));
        section.querySelector(`[data-panel-l1="${btn.dataset.l1Id}"]`).classList.add('is-active');
        
        backBtn.classList.add('is-hidden');
        resetNested();
      };
    });

    // Handle Drill Down (Level 2 to Level 3)
    drillBtns.forEach(btn => {
      btn.onclick = (e) => {
        e.preventDefault();
        const targetId = btn.dataset.target;
        const nestedPanel = section.querySelector(`#${targetId}`);
        const activeTab = section.querySelector('.l1-nav-item.is-active');

        if(nestedPanel && activeTab) {
          nestedPanel.classList.add('is-open');
          activeTab.innerText = btn.dataset.path; // UPDATE THE TAB TEXT
          backBtn.classList.remove('is-hidden');
        }
      };
    });

    // Handle Back Button
    backBtn.onclick = () => {
      resetNested();
      const activeTab = section.querySelector('.l1-nav-item.is-active');
      activeTab.innerText = activeTab.dataset.originalTitle; // REVERT THE TAB TEXT
      backBtn.classList.add('is-hidden');
    };

    function resetNested() {
      section.querySelectorAll('.drawer-panel-nested').forEach(p => p.classList.remove('is-open'));
    }

    // Drawer Controls
    section.querySelector('[data-drawer-trigger]').onclick = () => {
      drawer.classList.add('is-active');
      document.body.style.overflow = 'hidden';
    };
    section.querySelector('[data-drawer-close]').onclick = () => {
      drawer.classList.remove('is-active');
      document.body.style.overflow = '';
      // Optional: Reset menu state on close
      backBtn.click(); 
    };
  }

  document.addEventListener('DOMContentLoaded', initMobileMenu);
  document.addEventListener('shopify:section:load', initMobileMenu);
</script>

{% stylesheet %}
.mobile-tab-bar {
  position: fixed; bottom: 0; left: 0; width: 100%; background: #fff; z-index: 500;
  border-top: 1px solid #eee; padding-bottom: env(safe-area-inset-bottom);
}
.mobile-tab-bar__container { display: flex; height: 65px; }
.mobile-tab-bar__item { flex: 1; display: flex; align-items: center; justify-content: center; background: none; border: none; cursor: pointer; color: #000; }

/* Drawer */
.mobile-tab-bar__drawer-container { position: fixed; inset: 0; z-index: 1000; visibility: hidden; }
.mobile-tab-bar__drawer-container.is-active { visibility: visible; }
.mobile-tab-bar__drawer-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.3); opacity: 0; transition: 0.3s; }
.is-active .mobile-tab-bar__drawer-overlay { opacity: 1; }

.mobile-tab-bar__drawer {
  position: absolute; bottom: 0; left: 0; width: 100%; height: 100%;
  background: #fff; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.1, 0.9, 0.2, 1);
  display: flex; flex-direction: column;
}
.is-active .mobile-tab-bar__drawer { transform: translateY(0); }

/* Header & Tab Path Nav */
.drawer-header-actions { display: flex; justify-content: space-between; padding: 15px 20px 5px; align-items: center; min-height: 50px; }
.drawer-back-btn, .mobile-tab-bar__drawer-close { background: none; border: none; padding: 5px; cursor: pointer; display: flex; align-items: center; }

.drawer-l1-nav { border-bottom: 1px solid #f2f2f2; overflow-x: auto; -webkit-overflow-scrolling: touch; margin-top: 5px; }
.l1-nav-inner { display: flex; padding: 0 20px; gap: 5px; }
.l1-nav-item { 
  padding: 15px 0; margin-right: 25px; white-space: nowrap; background: none; border: none; font-size: 11px; 
  letter-spacing: 0.12em; color: #999; border-bottom: 2px solid transparent; text-transform: uppercase;
  transition: all 0.2s ease; cursor: pointer;
}
.l1-nav-item.is-active { color: #000; border-bottom-color: #000; font-weight: 500; }

/* Content & Panels */
.mobile-tab-bar__drawer-content { flex: 1; position: relative; overflow-y: auto; }
.drawer-panel { display: none; padding: 10px 25px; }
.drawer-panel.is-active { display: block; }

.drawer-links-list { list-style: none; padding: 0; margin: 0; }
.drawer-link-btn { 
  width: 100%; display: flex; justify-content: space-between; align-items: center;
  padding: 16px 0; background: none; border: none; font-size: 15px; text-align: left; color: #000;
  text-decoration: none; cursor: pointer; font-weight: 400; border-bottom: 0px;
}

/* Drill Down Panel */
.drawer-panel-nested { 
  position: absolute; inset: 0; background: #fff; padding: 10px 25px;
  transform: translateX(100%); transition: transform 0.3s ease-out; visibility: hidden; z-index: 10;
}
.drawer-panel-nested.is-open { transform: translateX(0); visibility: visible; }

.drawer-footer { 
  padding: 20px 25px; border-top: 1px solid #f2f2f2; display: flex; justify-content: space-between; 
  font-size: 10px; color: #888; letter-spacing: 0.05em; 
}
.drawer-footer a { text-decoration: none; color: inherit; }
.is-hidden { visibility: hidden; pointer-events: none; }
{% endstylesheet %}

{% schema %}
{
  "name": "Figma Mobile Menu",
  "settings": [
    { "type": "link_list", "id": "menu", "label": "Bottom Bar Icons" },
    { "type": "link_list", "id": "drawer_menu", "label": "Drawer Menu (3 Levels)" }
  ],
  "presets": [{ "name": "Figma Mobile Menu" }]
}
{% endschema %}