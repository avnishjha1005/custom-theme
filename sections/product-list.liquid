{% liquid
  assign max_items = section.settings.max_products
%}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />

<div class="section-background color-{{ section.settings.color_scheme }}"></div>
<div
  data-testid="product-list"
  class="section section--{{ section.settings.section_width }} color-{{ section.settings.color_scheme }} spacing-style"
  style="{% render 'spacing-style', settings: section.settings %}"
>
  <div class="section-resource-list__header">
    {%- content_for 'block', type: '_product-list-content', id: 'static-header' -%}
  </div>

  {% if section.settings.layout_type == 'carousel' %}
    <div class="swiper main-product-swiper" style="padding: 20px 0;">
      <div class="swiper-wrapper">
        {% if section.settings.collection != blank and shop.products_count != 0 %}
            {% for product in section.settings.collection.products limit: max_items %}
              <div class="swiper-slide">
                 {% content_for 'block', type: '_product-card', id: 'static-product-card', closest.product: product %}
              </div>
            {% endfor %}
        {% else %}
          {% for i in (1..max_items) %}
            <div class="swiper-slide">
               {% content_for 'block', type: '_product-card', id: 'static-product-card-1', closest.product: null %}
            </div>
          {% endfor %}
        {% endif %}
      </div>
      {% if section.settings.icons_style != 'none' %}
        <div class="swiper-button-next"></div>
        <div class="swiper-button-prev"></div>
      {% endif %}
    </div>
  {% else %}
    {% endif %}
</div>

<script async src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // 1. Initialize Main Product List Swiper (Free Mode)
    const mainSwiper = new Swiper('.main-product-swiper', {
      slidesPerView: "auto",
      spaceBetween: {{ section.settings.columns_gap | default: 20 }},
      freeMode: true,
      grabCursor: true,
      navigation: {
        nextEl: '.swiper-button-next',
        prevEl: '.swiper-button-prev',
      },
      breakpoints: {
        320: { slidesPerView: 1.5 },
        750: { slidesPerView: {{ section.settings.columns | default: 4 }} }
      }
    });

    // 2. Initialize Nested Card Swipers (if they exist inside _product-card)
    // We use a selector that targets the gallery inside the card
    const cardSwipers = new Swiper('.product-card-inner-swiper', {
      nested: true, // Crucial for carousels inside carousels
      slidesPerView: 1,
      pagination: {
        el: '.swiper-pagination',
        clickable: true
      }
    });
  });
</script>

<style>
  .main-product-swiper .swiper-slide {
    height: auto; /* Allows cards to define their own height */
    width: 280px; /* Default width for free mode items */
  }
  
  /* Prevent nested swiper from breaking the parent drag */
  .product-card-inner-swiper {
    overflow: hidden;
    position: relative;
  }
</style>