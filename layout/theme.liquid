<!doctype html>
<html
  class="no-js{% if request.design_mode %} shopify-design-mode{% endif %}"
  lang="{{ request.locale.iso_code }}"
>
  <head>
    {%- if settings.favicon != blank -%}
      <link
        rel="icon"
        type="image/png"
        href="{{ settings.favicon | image_url: width: 32, height: 32 }}"
      >
    {%- endif -%}

    {% comment %} This a way to wait for main content to load when navigating to a new page so that the view transitions can work consistently {% endcomment %}
    <link
      rel="expect"
      href="#MainContent"
      blocking="render"
      id="view-transition-render-blocker"
    >

    {%- render 'meta-tags' -%}
    {%- render 'stylesheets' -%}
    {%- render 'fonts' -%}
    {%- render 'scripts' -%}
    {%- render 'theme-styles-variables' -%}
    {%- render 'color-schemes' -%}

    {% if request.design_mode %}
      {%- render 'theme-editor' -%}
    {% endif %}

    {{ content_for_header }}
  </head>

  <body class="page-width-{{ settings.page_width }} card-hover-effect-{{ settings.card_hover_effect }}">
    {% render 'skip-to-content-link', href: '#MainContent', text: 'accessibility.skip_to_text' %}
    <div id="header-group">
      {% sections 'header-group' %}
    </div>

    <script
      src="{{ 'critical.js' | asset_url }}"
      type="module"
      async
      blocking="render"
    ></script>

    <main
      id="MainContent"
      class="content-for-layout"
      role="main"
      data-page-transition-enabled="{{ settings.page_transition_enabled }}"
      data-product-transition="{{ settings.transition_to_main_product }}"
      data-template="{{ template }}"
    >
      {{ content_for_layout }}
    </main>

    {% sections 'footer-group' %}

    {% render 'search-modal' %}

    {% if settings.quick_add or settings.mobile_quick_add %}
      {% render 'quick-add-modal' %}
    {% endif %}

    {%- comment -%}
      Mobile Tab Bar Section
      Sticky bottom navigation for mobile devices
    {%- endcomment -%}
     
    {% sections 'mobile-tab-bar' %}

    {% if settings.wishlist-floating-button-position %}
      <a href="/pages/wishlist" class="button-floating">
        <svg width="30px" height="30px" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <rect x="0" fill="none" width="24" height="24"/>

          <g>

          <path d="M16.5 4.5c2.206 0 4 1.794 4 4 0 4.67-5.543 8.94-8.5 11.023C9.043 17.44 3.5 13.17 3.5 8.5c0-2.206 1.794-4 4-4 1.298 0 2.522.638 3.273 1.706L12 7.953l1.227-1.746c.75-1.07 1.975-1.707 3.273-1.707m0-1.5c-1.862 0-3.505.928-4.5 2.344C11.005 3.928 9.362 3 7.5 3 4.462 3 2 5.462 2 8.5c0 5.72 6.5 10.438 10 12.85 3.5-2.412 10-7.13 10-12.85C22 5.462 19.538 3 16.5 3z"/>

          </g>
        </svg>
        <p class="wishlist_text">Your Wishlist</p>
      </a>
    {% endif %}

  </body>
  <script>
    // Wishlist Button Web Component
(function() {
  'use strict';
  
  if (customElements.get('wishlist-button')) return;

  class WishlistButton extends HTMLElement {
    constructor() {
      super();
      this.initialized = false;
      this.button = this.querySelector('[data-wishlist-button]');
      this.requireLogin = this.button?.dataset.requireLogin === 'true';
      
      this.productCard = this.closest('product-card') || 
                        this.parentElement?.closest('product-card');
      
      if (!this.productCard) {
        let el = this.parentElement;
        while (el && el.tagName !== 'PRODUCT-CARD') {
          el = el.parentElement;
        }
        this.productCard = el;
      }
      
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => this.init());
      } else {
        setTimeout(() => this.init(), 100);
      }
    }

    init() {
      if (this.initialized) return;
      this.initialized = true;
      
      this.productData = this.getProductDataFromCard();
      if (!this.productData) return;
      
      // Merge cloud data (from login) into local storage immediately on load
      this.mergeCloudWishlist();

      if (this.button) {
        this.button.replaceWith(this.button.cloneNode(true));
        this.button = this.querySelector('[data-wishlist-button]');
        this.button.addEventListener('click', this.handleClick.bind(this), { once: false });
      }
      
      this.checkWishlistState();
      this.updateWishlistCount();
      this.renderWishlistGrid();
    }

    getProductDataFromCard() {
      if (!this.productCard) return null;
      const productId = this.productCard.dataset.productId;
      if (!productId) return null;
      
      const productLink = this.productCard.querySelector('.product-card__link, a[href*="/products/"]');
      const productUrl = productLink?.href || '';
      const productHandle = productUrl.split('/products/')[1]?.split('?')[0] || '';
      
      const titleSelectors = ['.text-block h5 p', '.text-block p', 'h3', '.h4', '.h5', '[class*="product_title"]', '.card__heading'];
      let productTitle = '';
      for (const selector of titleSelectors) {
        const titleEl = this.productCard.querySelector(selector);
        if (titleEl && titleEl.textContent.trim()) {
          productTitle = titleEl.textContent.trim();
          break;
        }
      }
      
      const productImage = this.productCard.querySelector('img');
      const productImg = productImage?.src || productImage?.dataset?.src || '';
      const priceEl = this.productCard.querySelector('product-price .price, .price');
      const productPrice = priceEl?.textContent?.trim() || '';

      return {
        productId: productId,
        productHandle: productHandle,
        productTitle: productTitle || 'Product',
        productImg: productImg,
        productPrice: productPrice,
        productUrl: productUrl || `/products/${productHandle}`
      };
    }

    checkWishlistState() {
      if (!this.button || !this.productData) return;
      const wishlistData = JSON.parse(localStorage.getItem('wishlist')) || [];
      const isInWishlist = wishlistData.some(item => item.productId === this.productData.productId);
      if (isInWishlist) {
        this.button.classList.add('wishlist-button--active');
        this.button.setAttribute('aria-pressed', 'true');
      }
    }

    async handleClick(e) {
      e.preventDefault();
      e.stopPropagation();
      if (this.isProcessing) return;
      this.isProcessing = true;

      if (this.requireLogin && !window.Shopify?.customer) {
        window.location.href = '/account/login';
        return;
      }

      const isActive = this.button.classList.contains('wishlist-button--active');
      
      try {
        if (isActive) {
          await this.removeFromWishlist();
        } else {
          await this.addToWishlist();
        }

        this.button.classList.toggle('wishlist-button--active');
        this.button.setAttribute('aria-pressed', !isActive);
        this.showNotification(isActive ? 'removed' : 'added');
        
        // Refresh grid and count
        this.updateWishlistCount();
        this.renderWishlistGrid();
        
      } catch (error) {
        console.error('Wishlist error:', error);
      } finally {
        setTimeout(() => { this.isProcessing = false; }, 300);
      }
    }

    // --- NEW PERSISTENCE & RENDERING METHODS ---

    async syncWithShopify(wishlistData) {
      // Only sync if customer is logged in and the hidden form exists
      const form = document.querySelector('#WishlistSyncForm');
      const input = document.querySelector('#wishlist-metafield-input');
      if (!form || !input) return;

      input.value = JSON.stringify(wishlistData);
      const formData = new FormData(form);

      try {
        await fetch('/contact', { method: 'POST', body: formData });
      } catch (err) { console.error('Metafield sync failed', err); }
    }

    mergeCloudWishlist() {
      // Pull data from the global variable we will set in Liquid
      if (!window.wishlistConfig?.cloudData) return;
      
      const local = JSON.parse(localStorage.getItem('wishlist')) || [];
      const cloud = window.wishlistConfig.cloudData;
      
      // Merge unique items
      const merged = [...local, ...cloud].reduce((acc, current) => {
        const x = acc.find(item => item.productId === current.productId);
        return !x ? acc.concat([current]) : acc;
      }, []);

      localStorage.setItem('wishlist', JSON.stringify(merged));
    }

    renderWishlistGrid() {
      const wishlistBlock = document.querySelector('.js-wishlistBlock');
      if (!wishlistBlock) return;

      const wishlistData = JSON.parse(localStorage.getItem('wishlist')) || [];
      
      if (wishlistData.length === 0) {
        wishlistBlock.innerHTML = '<p class="wishlist-empty">Your wishlist is empty.</p>';
        return;
      }

      wishlistBlock.innerHTML = wishlistData.map(item => `
        <div class="wishlist-product__list">
            <div class="c-product">
                <a href="${item.productUrl}">
                    <img src="${item.productImg}" alt="${item.productTitle}">
                </a>
                <h3 class="c-product__title card__heading h5">
                    <a class="full-unstyled-link" href="${item.productUrl}">${item.productTitle}</a>
                </h3>
                <p class="price">${item.productPrice}</p>
                <button class="wishlist-remove-btn" onclick="document.querySelector('wishlist-button').removeFromWishlistById('${item.productId}')">
                  Remove
                </button>
            </div>
        </div>
      `).join('');
    }

    // --- UPDATED STORAGE METHODS ---

    async addToWishlist() {
      let wishlistData = JSON.parse(localStorage.getItem('wishlist')) || [];
      if (!wishlistData.some(item => item.productId === this.productId)) {
        wishlistData.push(this.productData);
        localStorage.setItem('wishlist', JSON.stringify(wishlistData));
        await this.syncWithShopify(wishlistData);
      }
    }

    async removeFromWishlist() {
      let wishlistData = JSON.parse(localStorage.getItem('wishlist')) || [];
      wishlistData = wishlistData.filter(item => item.productId !== this.productData.productId);
      localStorage.setItem('wishlist', JSON.stringify(wishlistData));
      await this.syncWithShopify(wishlistData);
    }

    removeFromWishlistById(id) {
      let wishlistData = JSON.parse(localStorage.getItem('wishlist')) || [];
      wishlistData = wishlistData.filter(item => item.productId !== id);
      localStorage.setItem('wishlist', JSON.stringify(wishlistData));
      
      this.syncWithShopify(wishlistData);
      this.renderWishlistGrid();
      this.updateWishlistCount();

      // Update button state if we are on the page of the product we just removed
      if (this.productData?.productId === id) {
        this.button?.classList.remove('wishlist-button--active');
        this.button?.setAttribute('aria-pressed', 'false');
      }
    }

    showNotification(action) {
      const message = action === 'added' ? 'Added to Wishlist' : 'Removed from Wishlist';
      const notification = document.createElement('div');
      notification.textContent = message;
      notification.className = 'wishlist-notification';
      notification.style.cssText = `position: fixed; top: 20px; right: 20px; background: #000; color: #fff; padding: 1rem 1.5rem; border-radius: 0.5rem; z-index: 9999;`;
      document.body.appendChild(notification);
      setTimeout(() => notification.remove(), 3000);
    }

    updateWishlistCount() {
      const wishlistData = JSON.parse(localStorage.getItem('wishlist')) || [];
      const countElement = document.querySelector('[data-wishlist-count]');
      if (countElement) {
        countElement.textContent = wishlistData.length;
        countElement.style.display = wishlistData.length > 0 ? 'block' : 'none';
      }
    }
  }

  customElements.define('wishlist-button', WishlistButton);
})();

function renderWishlistGrid() {
      const wishlistBlock = document.querySelector('.js-wishlistBlock');
      if (!wishlistBlock) {
        console.log('no block');
        return;
      }

      try {
        const wishlistData = JSON.parse(localStorage.getItem('wishlist')) || [];
        
        if (wishlistData.length === 0) {
          wishlistBlock.innerHTML = '<p class="wishlist-empty-msg">Your wishlist is currently empty.</p>';
          console.log('wishlist is empty');
          return;
        }

        const wishlistHtml = wishlistData.map(item => `
          <div class="wishlist-product__list" data-id="${item.productId}">
            <div class="c-product">
              <a href="${item.productUrl}">
                <img src="${item.productImg}" alt="${item.productTitle}" loading="lazy">
              </a>
              <h3 class="c-product__title card__heading h5">
                <a class="full-unstyled-link" href="${item.productUrl}">${item.productTitle}</a>
              </h3>
              <p class="price">${item.productPrice}</p>
              <button class="button button--secondary" 
                      onclick="this.closest('wishlist-button')?.removeFromWishlistById('${item.productId}')">
                Remove
              </button>
            </div>
          </div>
        `).join('');

        wishlistBlock.innerHTML = wishlistHtml;
      } catch (error) {
        console.error('Error rendering wishlist grid:', error);
      }
    }
    renderWishlistGrid();
</script>

</html>


