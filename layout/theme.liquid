<!doctype html>
<html
  class="no-js{% if request.design_mode %} shopify-design-mode{% endif %}"
  lang="{{ request.locale.iso_code }}"
>
  <head>
    {%- if settings.favicon != blank -%}
      <link
        rel="icon"
        type="image/png"
        href="{{ settings.favicon | image_url: width: 32, height: 32 }}"
      >
    {%- endif -%}

    {% comment %} This a way to wait for main content to load when navigating to a new page so that the view transitions can work consistently {% endcomment %}
    <link
      rel="expect"
      href="#MainContent"
      blocking="render"
      id="view-transition-render-blocker"
    >

    {%- render 'meta-tags' -%}
    {%- render 'stylesheets' -%}
    {%- render 'fonts' -%}
    {%- render 'scripts' -%}
    {%- render 'theme-styles-variables' -%}
    {%- render 'color-schemes' -%}

    {% if request.design_mode %}
      {%- render 'theme-editor' -%}
    {% endif %}

    {{ content_for_header }}
  </head>

  <body class="page-width-{{ settings.page_width }} card-hover-effect-{{ settings.card_hover_effect }}">
    {% render 'skip-to-content-link', href: '#MainContent', text: 'accessibility.skip_to_text' %}
    <div id="header-group">
      {% sections 'header-group' %}
    </div>

    <script
      src="{{ 'critical.js' | asset_url }}"
      type="module"
      async
      blocking="render"
    ></script>

    <main
      id="MainContent"
      class="content-for-layout"
      role="main"
      data-page-transition-enabled="{{ settings.page_transition_enabled }}"
      data-product-transition="{{ settings.transition_to_main_product }}"
      data-template="{{ template }}"
    >
      {{ content_for_layout }}
    </main>

    {% sections 'footer-group' %}

    {% render 'search-modal' %}

    {% if settings.quick_add or settings.mobile_quick_add %}
      {% render 'quick-add-modal' %}
    {% endif %}

    {%- comment -%}
      Mobile Tab Bar Section
      Sticky bottom navigation for mobile devices
    {%- endcomment -%}
     
    {% sections 'mobile-tab-bar' %}

    {% if settings.wishlist-floating-button-position %}
      <a href="/pages/wishlist" class="button-floating">
        <svg width="30px" height="30px" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <rect x="0" fill="none" width="24" height="24"/>

          <g>

          <path d="M16.5 4.5c2.206 0 4 1.794 4 4 0 4.67-5.543 8.94-8.5 11.023C9.043 17.44 3.5 13.17 3.5 8.5c0-2.206 1.794-4 4-4 1.298 0 2.522.638 3.273 1.706L12 7.953l1.227-1.746c.75-1.07 1.975-1.707 3.273-1.707m0-1.5c-1.862 0-3.505.928-4.5 2.344C11.005 3.928 9.362 3 7.5 3 4.462 3 2 5.462 2 8.5c0 5.72 6.5 10.438 10 12.85 3.5-2.412 10-7.13 10-12.85C22 5.462 19.538 3 16.5 3z"/>

          </g>
        </svg>
        <p class="wishlist_text">Your Wishlist</p>
      </a>
    {% endif %}

  </body>
  <script>
    // Wishlist Button Web Component
(function() {
  'use strict';
  
  // Only define the custom element once
  if (customElements.get('wishlist-button')) {
    return;
  }

  class WishlistButton extends HTMLElement {
    constructor() {
      super();
      this.initialized = false;
      this.button = this.querySelector('[data-wishlist-button]');
      this.requireLogin = this.button?.dataset.requireLogin === 'true';
      
      // Try multiple ways to find the product card
      this.productCard = this.closest('product-card') || 
                        this.parentElement?.closest('product-card');
      
      // If still not found, traverse up the DOM manually
      if (!this.productCard) {
        let el = this.parentElement;
        while (el && el.tagName !== 'PRODUCT-CARD') {
          el = el.parentElement;
        }
        this.productCard = el;
      }
      
      // Wait for DOM to be fully loaded before getting product data
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => this.init());
      } else {
        // Use longer timeout to ensure slideshow elements load first
        setTimeout(() => this.init(), 100);
      }
    }

    init() {
      // Prevent double initialization
      if (this.initialized) return;
      this.initialized = true;
      
      this.productData = this.getProductDataFromCard();
      
      if (!this.productData) {
        console.warn('Wishlist button: Could not find product data');
        return;
      }
      
      // Remove any existing listeners before adding new one
      if (this.button) {
        this.button.replaceWith(this.button.cloneNode(true));
        this.button = this.querySelector('[data-wishlist-button]');
        this.button.addEventListener('click', this.handleClick.bind(this), { once: false });
      }
      
      // Check if product is already in wishlist on load
      this.checkWishlistState();
      this.renderWishlistGrid();
    }

    getProductDataFromCard() {
      if (!this.productCard) {
        console.error('No product card found');
        return null;
      }

      const productId = this.productCard.dataset.productId;
      if (!productId) {
        console.error('No product ID found');
        return null;
      }
      
      // Get product link and URL
      const productLink = this.productCard.querySelector('.product-card__link, a[href*="/products/"]');
      const productUrl = productLink?.href || '';
      const productHandle = productUrl.split('/products/')[1]?.split('?')[0] || '';
      
      // Get product title - try multiple selectors
      const titleSelectors = [
        '.text-block h5 p',
        '.text-block p',
        'h3',
        '.h4',
        '.h5',
        '[class*="product_title"]',
        '.card__heading'
      ];
      
      let productTitle = '';
      for (const selector of titleSelectors) {
        const titleEl = this.productCard.querySelector(selector);
        if (titleEl && titleEl.textContent.trim()) {
          productTitle = titleEl.textContent.trim();
          break;
        }
      }
      
      // Fallback to visually-hidden text
      if (!productTitle) {
        const hiddenTitle = this.productCard.querySelector('.visually-hidden');
        productTitle = hiddenTitle?.textContent?.trim() || 'Product';
      }
      
      // Get product image
      const productImage = this.productCard.querySelector('img');
      const productImg = productImage?.src || productImage?.dataset?.src || '';
      
      // Get product price
      const priceEl = this.productCard.querySelector('product-price .price, .price');
      const productPrice = priceEl?.textContent?.trim() || '';

      const data = {
        productId: productId,
        productHandle: productHandle,
        productTitle: productTitle,
        productImg: productImg,
        productPrice: productPrice,
        productUrl: productUrl || `/products/${productHandle}`
      };
      
      return data;
    }

    checkWishlistState() {
      if (!this.button || !this.productData) return;
      
      try {
        const wishlistData = JSON.parse(localStorage.getItem('wishlist')) || [];
        const isInWishlist = wishlistData.some(item => item.productId === this.productData.productId);
        
        if (isInWishlist) {
          this.button.classList.add('wishlist-button--active');
          this.button.setAttribute('aria-pressed', 'true');
        }
      } catch (error) {
        console.error('Error checking wishlist state:', error);
      }
    }

    async handleClick(e) {
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation(); // Prevent other listeners from firing

      // Prevent rapid double-clicks
      if (this.isProcessing) return;
      this.isProcessing = true;

      // Check if login is required
      if (this.requireLogin && !window.Shopify?.customer) {
        window.location.href = '/account/login';
        return;
      }

      const isActive = this.button.classList.contains('wishlist-button--active');
      
      try {
        // Toggle wishlist state
        if (isActive) {
          await this.removeFromWishlist();
        } else {
          await this.addToWishlist();
        }

        // Toggle UI state
        this.button.classList.toggle('wishlist-button--active');
        this.button.setAttribute('aria-pressed', !isActive);

        // Show notification
        this.showNotification(isActive ? 'removed' : 'added');

        // Dispatch custom event
        this.dispatchEvent(new CustomEvent('wishlist:toggle', {
          bubbles: true,
          detail: { productId: this.productData.productId, inWishlist: !isActive }
        }));

        // Update wishlist count if there's a counter element
        this.updateWishlistCount();
      } catch (error) {
        console.error('Wishlist error:', error);
      } finally {
        // Re-enable after a short delay
        setTimeout(() => {
          this.isProcessing = false;
        }, 300);
      }
    }

    async addToWishlist() {
      let wishlistData = JSON.parse(localStorage.getItem('wishlist')) || [];
      
      // Check if already exists
      const exists = wishlistData.some(item => item.productId === this.productData.productId);
      if (!exists) {
        wishlistData.push(this.productData);
        localStorage.setItem('wishlist', JSON.stringify(wishlistData));
        console.log('Added to wishlist:', this.productData.productTitle);
      }
    }

    async removeFromWishlist() {
      let wishlistData = JSON.parse(localStorage.getItem('wishlist')) || [];
      wishlistData = wishlistData.filter(item => item.productId !== this.productData.productId);
      localStorage.setItem('wishlist', JSON.stringify(wishlistData));
      console.log('Removed from wishlist:', this.productData.productId);
    }

    showNotification(action) {
      const message = action === 'added' 
        ? 'Added to Wishlist' 
        : 'Removed from Wishlist';
      
      // Simple notification
      const notification = document.createElement('div');
      notification.textContent = message;
      notification.className = 'wishlist-notification';
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #000;
        color: #fff;
        padding: 1rem 1.5rem;
        border-radius: 0.5rem;
        z-index: 9999;
        animation: slideIn 0.3s ease;
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    updateWishlistCount() {
      try {
        const wishlistData = JSON.parse(localStorage.getItem('wishlist')) || [];
        const countElement = document.querySelector('[data-wishlist-count]');
        if (countElement) {
          countElement.textContent = wishlistData.length;
          countElement.style.display = wishlistData.length > 0 ? 'block' : 'none';
        }
      } catch (error) {
        console.error('Error updating wishlist count:', error);
      }
    }

    // Helper to allow removal from the grid specifically
    removeFromWishlistById(id) {
        let wishlistData = JSON.parse(localStorage.getItem('wishlist')) || [];
        wishlistData = wishlistData.filter(item => item.productId !== id);
        localStorage.setItem('wishlist', JSON.stringify(wishlistData));
        
        // Refresh all wishlist UI components
        this.renderWishlistGrid();
        this.updateWishlistCount();
        
        // If the current page is a product page for this ID, toggle its button state
        if (this.productData?.productId === id) {
             this.button?.classList.remove('wishlist-button--active');
             this.button?.setAttribute('aria-pressed', 'false');
        }
    }
  }

  customElements.define('wishlist-button', WishlistButton);
})();

renderWishlistGrid() {
      const wishlistBlock = document.querySelector('.js-wishlistBlock');
      if (!wishlistBlock) {
        console.log('no block');
        return;
      }

      try {
        const wishlistData = JSON.parse(localStorage.getItem('wishlist')) || [];
        
        if (wishlistData.length === 0) {
          wishlistBlock.innerHTML = '<p class="wishlist-empty-msg">Your wishlist is currently empty.</p>';
          console.log('wishlist is empty');
          return;
        }

        const wishlistHtml = wishlistData.map(item => `
          <div class="wishlist-product__list" data-id="${item.productId}">
            <div class="c-product">
              <a href="${item.productUrl}">
                <img src="${item.productImg}" alt="${item.productTitle}" loading="lazy">
              </a>
              <h3 class="c-product__title card__heading h5">
                <a class="full-unstyled-link" href="${item.productUrl}">${item.productTitle}</a>
              </h3>
              <p class="price">${item.productPrice}</p>
              <button class="button button--secondary" 
                      onclick="this.closest('wishlist-button')?.removeFromWishlistById('${item.productId}')">
                Remove
              </button>
            </div>
          </div>
        `).join('');

        wishlistBlock.innerHTML = wishlistHtml;
      } catch (error) {
        console.error('Error rendering wishlist grid:', error);
      }
    }
    renderWishlistGrid();
</script>

</html>


