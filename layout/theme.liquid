<!doctype html>
<html
  class="no-js{% if request.design_mode %} shopify-design-mode{% endif %}"
  lang="{{ request.locale.iso_code }}"
><script>
  window.Shopify = window.Shopify || {};
  window.wishlistConfig = {
    customerLoggedIn: {% if customer %}true{% else %}false{% endif %},
    // Pull the JSON metafield data safely
    cloudData: {% if customer.metafields.custom.wishlist != blank %}{{ customer.metafields.custom.wishlist.value | json }}{% else %}[]{% endif %}
  };
</script>

{% if customer %}
  {% comment %} Hidden form to allow JS to save data back to the customer metafield {% endcomment %}
  {% form 'customer', id: 'WishlistSyncForm', style: 'display:none;' %}
    <input type="hidden" name="customer[metafields][custom][wishlist]" id="wishlist-metafield-input">
  {% endform %}
{% endif %}
  <head>
    {%- if settings.favicon != blank -%}
      <link
        rel="icon"
        type="image/png"
        href="{{ settings.favicon | image_url: width: 32, height: 32 }}"
      >
    {%- endif -%}

    {% comment %} This a way to wait for main content to load when navigating to a new page so that the view transitions can work consistently {% endcomment %}
    <link
      rel="expect"
      href="#MainContent"
      blocking="render"
      id="view-transition-render-blocker"
    >

    {%- render 'meta-tags' -%}
    {%- render 'stylesheets' -%}
    {%- render 'fonts' -%}
    {%- render 'scripts' -%}
    {%- render 'theme-styles-variables' -%}
    {%- render 'color-schemes' -%}

    {% if request.design_mode %}
      {%- render 'theme-editor' -%}
    {% endif %}

    {{ content_for_header }}
  </head>

  <body class="page-width-{{ settings.page_width }} card-hover-effect-{{ settings.card_hover_effect }}">
    {% render 'skip-to-content-link', href: '#MainContent', text: 'accessibility.skip_to_text' %}
    <div id="header-group">
      {% sections 'header-group' %}
    </div>

    <script
      src="{{ 'critical.js' | asset_url }}"
      type="module"
      async
      blocking="render"
    ></script>

    <main
      id="MainContent"
      class="content-for-layout"
      role="main"
      data-page-transition-enabled="{{ settings.page_transition_enabled }}"
      data-product-transition="{{ settings.transition_to_main_product }}"
      data-template="{{ template }}"
    >
      {{ content_for_layout }}
    </main>

    {% sections 'footer-group' %}

    {% render 'search-modal' %}

    {% if settings.quick_add or settings.mobile_quick_add %}
      {% render 'quick-add-modal' %}
    {% endif %}

    {%- comment -%}
      Mobile Tab Bar Section
      Sticky bottom navigation for mobile devices
    {%- endcomment -%}
     
    {% sections 'mobile-tab-bar' %}

    {% if settings.wishlist-floating-button-position %}
      <a href="/pages/wishlist" class="button-floating">
        <svg width="30px" height="30px" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <rect x="0" fill="none" width="24" height="24"/>

          <g>

          <path d="M16.5 4.5c2.206 0 4 1.794 4 4 0 4.67-5.543 8.94-8.5 11.023C9.043 17.44 3.5 13.17 3.5 8.5c0-2.206 1.794-4 4-4 1.298 0 2.522.638 3.273 1.706L12 7.953l1.227-1.746c.75-1.07 1.975-1.707 3.273-1.707m0-1.5c-1.862 0-3.505.928-4.5 2.344C11.005 3.928 9.362 3 7.5 3 4.462 3 2 5.462 2 8.5c0 5.72 6.5 10.438 10 12.85 3.5-2.412 10-7.13 10-12.85C22 5.462 19.538 3 16.5 3z"/>

          </g>
        </svg>
        <p class="wishlist_text">Your Wishlist</p>
      </a>
    {% endif %}

  </body>
  <script>
    // Wishlist Button Web Component
((function() {
  'use strict';
  if (customElements.get('wishlist-button')) return;

  class WishlistButton extends HTMLElement {
    constructor() {
      super();
      this.initialized = false;
      this.isProcessing = false;
      this.button = this.querySelector('[data-wishlist-button]');
      
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => this.init());
      } else {
        setTimeout(() => this.init(), 100);
      }
    }

    init() {
      if (this.initialized) return;
      this.initialized = true;

      this.productData = this.getProductDataFromCard();
      if (!this.productData) return;

      // Clean up and attach listeners
      if (this.button) {
        this.button.addEventListener('click', this.handleClick.bind(this));
      }

      // 1. Initial Merge: If logged in, merge cloud data into local storage
      this.mergeCloudWishlist();
      // 2. Initial UI Sync
      this.checkWishlistState();
      this.updateWishlistCount();
      this.renderWishlistGrid();
    }

    getProductDataFromCard() {
      // Find the closest product card container
      const card = this.closest('product-card') || this.closest('.product-grid-item') || document;
      const productId = card.dataset?.productId || "{{ product.id }}"; // Fallback for PDP
      
      return {
        productId: productId.toString(),
        productHandle: window.location.pathname.split('/products/')[1] || "",
        productTitle: card.querySelector('.card__heading, h3, h1')?.textContent.trim() || "Product",
        productImg: card.querySelector('img')?.src || "",
        productPrice: card.querySelector('.price')?.textContent.trim() || "",
        productUrl: card.querySelector('a')?.href || window.location.href
      };
    }

    async handleClick(e) {
      e.preventDefault();
      if (this.isProcessing) return;
      this.isProcessing = true;

      const isActive = this.button.classList.contains('wishlist-button--active');
      
      if (isActive) {
        await this.removeFromWishlist();
      } else {
        await this.addToWishlist();
      }

      this.updateUI(!isActive);
      this.isProcessing = false;
    }

    updateUI(isInWishlist) {
      // Update all buttons for this product on the page
      const allSameProductButtons = document.querySelectorAll(`wishlist-button`);
      allSameProductButtons.forEach(btn => {
        if (btn.productData?.productId === this.productData.productId) {
          btn.button?.classList.toggle('wishlist-button--active', isInWishlist);
          btn.button?.setAttribute('aria-pressed', isInWishlist);
        }
      });

      this.updateWishlistCount();
      this.renderWishlistGrid();
    }

    async addToWishlist() {
      let data = JSON.parse(localStorage.getItem('wishlist')) || [];
      if (!data.some(item => item.productId === this.productData.productId)) {
        data.push(this.productData);
        localStorage.setItem('wishlist', JSON.stringify(data));
        await this.syncWithShopify(data);
      }
    }

    async removeFromWishlist() {
      let data = JSON.parse(localStorage.getItem('wishlist')) || [];
      data = data.filter(item => item.productId !== this.productData.productId);
      localStorage.setItem('wishlist', JSON.stringify(data));
      await this.syncWithShopify(data);
    }

    async syncWithShopify(wishlistData) {
      if (!window.wishlistConfig.customerLoggedIn) return;

      const input = document.querySelector('#wishlist-metafield-input');
      const form = document.querySelector('#WishlistSyncForm');
      if (!input || !form) return;

      input.value = JSON.stringify(wishlistData);
      const formData = new FormData(form);

      try {
        await fetch('/contact', { method: 'POST', body: formData });
        console.log('Wishlist synced to Shopify Metafields');
      } catch (err) { console.error('Sync failed', err); }
    }

    mergeCloudWishlist() {
      if (!window.wishlistConfig.customerLoggedIn) return;
      
      const local = JSON.parse(localStorage.getItem('wishlist')) || [];
      const cloud = window.wishlistConfig.cloudData || [];
      
      // Merge unique items by productId
      const merged = [...local, ...cloud].reduce((acc, current) => {
        const x = acc.find(item => item.productId === current.productId);
        return !x ? acc.concat([current]) : acc;
      }, []);

      localStorage.setItem('wishlist', JSON.stringify(merged));
    }

    renderWishlistGrid() {
      const grid = document.querySelector('.js-wishlistBlock');
      if (!grid) return;

      const data = JSON.parse(localStorage.getItem('wishlist')) || [];
      if (data.length === 0) {
        grid.innerHTML = '<p>Your wishlist is empty.</p>';
        return;
      }

      grid.innerHTML = data.map(item => `
        <div class="wishlist-item">
          <img src="${item.productImg}" width="100">
          <h4>${item.productTitle}</h4>
          <p>${item.productPrice}</p>
          <button onclick="document.querySelector('wishlist-button').removeById('${item.productId}')">Remove</button>
        </div>
      `).join('');
    }

    removeById(id) {
        let data = JSON.parse(localStorage.getItem('wishlist')) || [];
        data = data.filter(item => item.productId !== id);
        localStorage.setItem('wishlist', JSON.stringify(data));
        this.syncWithShopify(data);
        this.updateUI(false);
    }

    checkWishlistState() {
      const data = JSON.parse(localStorage.getItem('wishlist')) || [];
      const isMatch = data.some(item => item.productId === this.productData.productId);
      this.button?.classList.toggle('wishlist-button--active', isMatch);
    }

    updateWishlistCount() {
      const count = (JSON.parse(localStorage.getItem('wishlist')) || []).length;
      document.querySelectorAll('[data-wishlist-count]').forEach(el => {
        el.textContent = count;
        el.style.display = count > 0 ? 'block' : 'none';
      });
    }
  }

  customElements.define('wishlist-button', WishlistButton);
})();
    renderWishlistGrid();
</script>

</html>


