{%- comment -%}
  Figma-Style Mobile Menu Drawer - V2 (Icon Fix)
  - L1: Horizontal Pills (No duplicates)
  - L2: List View with Drill-down
  - Breadcrumb: Active pill updates to "L1 / L2" path
{%- endcomment -%}

<header-drawer>
  <details id="Details-menu-drawer-container" class="menu-drawer-container">
    <summary class="header__icon header__icon--menu header__icon--summary focus-inset" aria-label="{{ 'sections.shop_the_look.view_product' | t }}">
      <span class="menu-drawer-icon-wrapper">
        <span class="header-drawer-icon header-drawer-icon--open icon-hamburger-container">
          {{- 'icon-menu.svg' | inline_asset_content -}}
        </span>
        <span class="icon-close-container">
          {{- 'icon-menu.svg' | inline_asset_content -}}
        </span>
      </span>
    </summary>

    <div id="menu-drawer" class="menu-drawer gradient motion-reduce" tabindex="-1">
      <div class="menu-drawer__inner-container">
        
        {% comment %} Header Actions (Internal Back/Close) {% endcomment %}
        <div class="drawer-header-actions">
          <button type="button" class="drawer-back-btn is-hidden" id="Drawer-Back-Btn" aria-label="Back">
            <span class="arrow-icon">
              <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </span>
          </button>
          <button type="button" class="drawer-close-btn" id="Drawer-Close-Btn" aria-label="Close">
             <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="1.2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
          </button>
        </div>

        {% comment %} Level 1: Horizontal Pill Navigation {% endcomment %}
        <nav class="drawer-l1-nav">
          <div class="l1-nav-inner" id="L1-Pill-Container">
            {%- for link in linklist.links -%}
              <button type="button" 
                class="pill-item {% if forloop.first %}is-active{% endif %}" 
                data-l1-index="{{ forloop.index }}"
                data-original-title="{{ link.title | escape }}">
                {{ link.title | escape }}
              </button>
            {%- endfor -%}
          </div>
        </nav>

        {% comment %} Main Content Panels {% endcomment %}
        <div class="drawer-panels-container">
          {%- for l1_link in linklist.links -%}
            <div class="drawer-panel {% if forloop.first %}is-active{% endif %}" data-panel-l1="{{ forloop.index }}">
              <ul class="drawer-links-list" role="list">
                {%- for l2_link in l1_link.links -%}
                  <li class="drawer-item-container">
                    {%- if l2_link.links != blank -%}
                      <button type="button" class="drawer-link-btn"
                        data-drill-down 
                        data-target="Panel-{{ forloop.parentloop.index }}-{{ forloop.index }}"
                        data-path="{{ l1_link.title | escape }} / {{ l2_link.title | escape }}">
                        <span class="link-text">{{ l2_link.title | escape }}</span>
                        <span class="arrow-icon">
                          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                        </span>
                      </button>

                      {% comment %} Level 3: Nested Slide-in Panel {% endcomment %}
                      <div class="drawer-panel-nested" id="Panel-{{ forloop.parentloop.index }}-{{ forloop.index }}">
                        <ul class="drawer-links-list" role="list">
                          {%- for l3_link in l2_link.links -%}
                            <li>
                              <a href="{{ l3_link.url }}" class="drawer-link-btn">
                                {{ l3_link.title | escape }}
                              </a>
                            </li>
                          {%- endfor -%}
                        </ul>
                      </div>
                    {%- else -%}
                      <a href="{{ l2_link.url }}" class="drawer-link-btn">
                        {{ l2_link.title | escape }}
                      </a>
                    {%- endif -%}
                  </li>
                {%- endfor -%}
              </ul>
            </div>
          {%- endfor -%}
        </div>

        <div class="drawer-footer">
          <span>{{ localization.country.name }} ({{ localization.country.currency.iso_code }})</span>
          <a href="/pages/contact">CONTACT US</a>
        </div>
      </div>
    </div>
  </details>
</header-drawer>

<style>
  /* Header Icon Fix */
  .icon-close-container { display: none; }
  details[open] .icon-hamburger-container { display: none; }
  details[open] .icon-close-container { display: block; }
  
  .menu-drawer-icon-wrapper svg {
    display: block;
  }

  /* Drawer Styling */
  .menu-drawer {z-index:-1;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    background: #fff;
    z-index: 1000;
    transform: translateY(100%);
    transition: transform 0.3s cubic-bezier(0.1, 0.9, 0.2, 1);
    display: flex;
    flex-direction: column;
  }
  
  details[open] > .menu-drawer { transform: translateX(0); }

  .drawer-header-actions {
    display: flex;
    justify-content: space-between;
    padding: 10px;
    min-height: 50px;
  }

  .drawer-back-btn, .drawer-close-btn {
    background: none; border: none; cursor: pointer; padding: 12px;
  }

  /* L1 Pills */
  .drawer-l1-nav { overflow-x: auto; scrollbar-width: none; }
  .drawer-l1-nav::-webkit-scrollbar { display: none; }
  .l1-nav-inner { display: flex; padding: 19px 0px 0px 16px; gap: 10px; }

  .pill-item {
    white-space: nowrap; background: #fff; border: none; border-radius: 20px;
    padding:0px; font-size: 10px; font-weight: medium; cursor: pointer; color: #000;
    text-transform:uppercase;
  }
  .pill-item.is-active { text-decoration:underline; font-weight:bold;}

  /* Content */
  .drawer-panels-container { flex: 1; position: relative; overflow: hidden; height:80%}
  .drawer-panel { display: none; padding: 10px 16px; height: 100%; overflow-y: auto; }
  .drawer-panel.is-active { display: block; }

  .drawer-links-list { list-style: none; padding: 0; margin: 0; }
  .drawer-link-btn {
    width: 100%; display: flex; justify-content: space-between; align-items: center;
    padding: 0 0 12px 0; background: none; 
    font-size: 16px; text-align: left; color: #000; text-decoration: none;
  }

  /* L3 Drill-down */
  .drawer-panel-nested {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: #fff; padding: 10px 16px; transform: translateX(100%);
    transition: transform 0.3s ease; visibility: hidden; z-index: 10;
  }
  .drawer-panel-nested.is-open { transform: translateX(0); visibility: visible; }

  .drawer-footer { padding: 20px 16px; border-top: 1px solid #f2f2f2; display: flex; justify-content: space-between; font-size: 12px; color: #888; }
  .is-hidden { visibility: hidden; pointer-events: none; }
  .menu-drawer__inner-container{height: calc(100svh - 56px);}
  .menu-drawer{height: calc(100svh - 56px);}
</style>

<script>
  if (!customElements.get('header-drawer')) {
    customElements.define('header-drawer', class extends HTMLElement {
      constructor() {
        super();
        this.details = this.querySelector('details');
        this.backBtn = this.querySelector('#Drawer-Back-Btn');
        this.closeBtn = this.querySelector('#Drawer-Close-Btn');
        this.pillBtns = this.querySelectorAll('.pill-item');
        this.drillBtns = this.querySelectorAll('[data-drill-down]');
        this.panels = this.querySelectorAll('.drawer-panel');
        this.nestedPanels = this.querySelectorAll('.drawer-panel-nested');
        this.init();
      }

      init() {
        // Pill Navigation logic
        this.pillBtns.forEach(btn => {
          btn.addEventListener('click', () => {
            this.resetMenuState();
            this.pillBtns.forEach(b => b.classList.remove('is-active'));
            btn.classList.add('is-active');
            this.panels.forEach(p => p.classList.remove('is-active'));
            const target = this.querySelector(`[data-panel-l1="${btn.dataset.l1Index}"]`);
            if (target) target.classList.add('is-active');
          });
        });

        // Drill down to L3 logic
        this.drillBtns.forEach(btn => {
          btn.addEventListener('click', () => {
            const targetId = btn.dataset.target;
            const nested = this.querySelector(`#${targetId}`);
            const activePill = this.querySelector('.pill-item.is-active');
            if (nested && activePill) {
              nested.classList.add('is-open');
              activePill.innerText = btn.dataset.path; // Update Breadcrumb path
              this.backBtn.classList.remove('is-hidden');
            }
          });
        });

        this.backBtn.addEventListener('click', () => this.resetMenuState());
        this.closeBtn.addEventListener('click', () => {
          this.details.removeAttribute('open');
          this.resetMenuState();
        });
      }

      resetMenuState() {
        this.nestedPanels.forEach(p => p.classList.remove('is-open'));
        this.backBtn.classList.add('is-hidden');
        this.pillBtns.forEach(btn => {
          btn.innerText = btn.dataset.originalTitle;
        });
      }
    });
  }
</script>