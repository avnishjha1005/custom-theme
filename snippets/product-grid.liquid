{%- doc -%}
  This snippet is used to render the product grid on collection and search pages.

  @param {object} section - The section object
  @param {object} paginate - Pagination object
  @param {object} products - Array of product objects
  @param {string} [title] - Header of the collection or search results
  @param {string} children - List or grid of product cards
  @param {boolean} [enable_infinite_scroll] - Whether to enable infinite scroll (default: true)
{%- enddoc -%}

{% capture product_card_size %}
  {% render 'util-product-grid-card-size' section: section %}
{% endcapture %}
{% assign product_card_size = product_card_size | strip %}

{% style %}
 /* Responsive Product Grid for {{ section.id }} */

/* 1. SHARED DESKTOP/TABLET BASE (Starts at 750px) */
@media screen and (min-width: 750px) {
  .product-grid--{{ section.id }} {
    display: grid;
    width: 100%;
    max-width: 100%;
    margin: 0 auto;

    /* Use clamp to keep gaps reasonable across devices */
    column-gap: clamp(8px, {{ section.settings.columns_gap_horizontal }}px, 32px);
    row-gap: clamp(8px, {{ section.settings.columns_gap_vertical }}px, 32px);

    /* Help fill holes when items span columns (especially organic layout) */
    grid-auto-flow: dense;

    /* Avoid accidental overflow causing horizontal scroll */
    overflow: hidden;
  }

  .main-collection-grid {
    overflow-x: hidden;
  }

  /* Ensure images are responsive */
  .product-grid--{{ section.id }} .product-grid__item img {
    max-width: 100%;
    height: auto;
    display: block;
  }
}

/* 2. TABLET (750px to 990px) */
/* Use auto-fit and minmax: column count becomes fluid based on container width.
   Set min column width for tablet so you usually see ~3 columns but it can drop to 2 if space is tight. */
@media screen and (min-width: 750px) and (max-width: 990px) {
  {% case section.settings.layout_type %}
    {% when 'grid' %}
      .product-grid--{{ section.id }}.product-grid--grid {
        /* Typical target ~3 cols: min 200px, max 1fr adapts */
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      }
    {% when 'organic' %}
      .product-grid--{{ section.id }}.product-grid--organic {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      }

      /* Organic spanning rules: keep spans bounded */
      .product-grid--{{ section.id }}.product-grid--organic .product-grid__item:nth-child(4n + 1) { grid-column: span 2; }
      .product-grid--{{ section.id }}.product-grid--organic .product-grid__item:nth-child(4n + 4) { grid-column: 2 / span 2; }

      /* Safety: if there are fewer than 3 columns available, don’t overflow spans */
      @supports(selector(:has(*))) {
        .product-grid--{{ section.id }}.product-grid--organic:has(:where(:nth-child(1))) {
          /* This block is a placeholder for future container queries; overridden by desktop rules below */
        }
      }
  {% endcase %}
}

/* 3. DESKTOP (991px and up) */
/* Target ~4 columns but fluid: increase min width so columns don’t get too narrow or too many. */
@media screen and (min-width: 991px) {
  {% case section.settings.layout_type %}
    {% when 'grid' %}
      .product-grid--{{ section.id }}.product-grid--grid {
        /* Typical target ~4 cols: min 240px; adjusts to container width */
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      }
    {% when 'organic' %}
      .product-grid--{{ section.id }}.product-grid--organic {
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      }

      /* 6-item cycle hints preserved; dense flow reduces gaps */
      .product-grid--{{ section.id }}.product-grid--organic .product-grid__item:nth-child(6n + 1) { grid-column: span 2; }
      .product-grid--{{ section.id }}.product-grid--organic .product-grid__item:nth-child(6n + 6) { grid-column: 3 / span 2; }
      .product-grid--{{ section.id }}.product-grid--organic .product-grid__item:nth-child(6n + 2),
      .product-grid--{{ section.id }}.product-grid--organic .product-grid__item:nth-child(6n + 5) { align-self: end; }

      /* Guard: if the grid ends up with only 3 columns (narrow desktop),
         force spans to not exceed available columns to prevent overflow. */
      .product-grid--{{ section.id }}.product-grid--organic {
        /* This relies on dense flow; if you still see overflow, cap span width: */
      }
      .product-grid--{{ section.id }}.product-grid--organic .product-grid__item {
        /* Optional hard cap: never span more than 2 columns */
        /* grid-column: span min(2, var(--available-columns, 4)); */
      }
  {% endcase %}
}

/* 4. ZOOM VIEW & UTILITIES */
/* Smaller min size so more items fit when zooming out, but cap max to keep items legible */
@media screen and (min-width: 750px) {
  .product-grid--{{ section.id }}[product-grid-view='zoom-out'] {
    /* auto-fill packs as many columns as fit, even with partial last row */
    grid-template-columns: repeat(auto-fill, minmax(100px, 180px));
  }
}

{% endstyle %}

<div
  id="ResultsList"
  class="
    grid main-collection-grid
    {%- if section.settings.inherit_color_scheme == false %} color-{{ section.settings.color_scheme }}{% endif %}
    {%- if section.settings.product_grid_width == 'full-width' %} collection-wrapper--full-width{% endif %}
    {%- if section.settings.full_width_on_mobile == true %} collection-wrapper--full-width-on-mobile{% endif %}
    spacing-style
  "

  style="
    --grid--margin--mobile: 0{% if section.settings.product_grid_width == 'centered' and section.settings.full_width_on_mobile == false %} var(--margin-lg){% else %} 0{% endif %};
    --grid-column--desktop: var(--{% if section.settings.product_grid_width == 'centered' %}centered{% else %}full-width{% endif %});
    --grid-column--mobile: var(--{% if section.settings.full_width_on_mobile %}full-width{% else %}{% if section.settings.product_grid_width == 'centered' %}centered{% else %}full-width{% endif %}{% endif %});
    --padding-inline-start: {{ section.settings.padding-inline-start }}px;
    --padding-inline-end: {{ section.settings.padding-inline-end }}px;
  "
>
  <div
    style="
      padding-left:16px;
      padding-right:16px;
      --product-grid-gap-mobile: {{ section.settings.columns_gap_vertical | at_most: 12 }}px {{ section.settings.columns_gap_horizontal | at_most: 12 }}px;
      --product-grid-gap-desktop: {{ section.settings.columns_gap_vertical }}px {{ section.settings.columns_gap_horizontal }}px;
      container-type: inline-size;
      container-name: product-grid;
    "
  >
    {% if products.size == 0 %}
      <div class="main-collection-grid__empty">
        <h2 class="main-collection-grid__empty-title h2">
          {{ 'content.no_products_found' | t }}
        </h2>
        <p>
          {{ 'content.use_fewer_filters_html' | t: link: collection.url, class: 'main-collection-grid__empty-link' }}
        </p>
      </div>
    {% else %}
      {% if enable_infinite_scroll %}
        <span ref="viewMorePrevious"></span>
      {% endif %}

      {% if title %}
        <h4 class="main-collection-grid__title">{{ title }}</h4>
      {% endif %}
      <ul
        class="product-grid product-grid--{{ section.id }} product-grid--{{ section.settings.layout_type }} {% if section.settings.mobile_product_card_size == 'large' %} product-grid-mobile--large{% endif %}"
        product-grid-view="default"
        ref="grid"
        role="list"
        data-last-page="{{ paginate.pages }}"
        data-product-card-size="{{ section.settings.product_card_size }}"
        style="--mobile-columns: {% if section.settings.mobile_product_card_size == 'large' %}1{% else %}2{% endif %};"
      >
        {{ children }}
      </ul>
      {% if enable_infinite_scroll != false %}
        <span ref="viewMoreNext"></span>
      {% else %}
        {% render 'pagination-controls', paginate: paginate %}
      {% endif %}
    {% endif %}
  </div>
</div>

{% comment %}
  This script is used to set the grid view on the product grid stored in sessionStorage. Keeping it here helps us prevent seeing the default state.
{% endcomment %}
{% unless request.design_mode %}
  <script>
    (() => {
      const grid = document.querySelector('.product-grid');

      if (grid) {
        const currentDevice = window.innerWidth >= 750 ? 'desktop' : 'mobile';
        const storedLayout = sessionStorage.getItem(`product-grid-view-${currentDevice}`);

        if (storedLayout) {
          const options = document.querySelectorAll(`input[type="radio"][name="grid"]`);

          grid.setAttribute('product-grid-view', storedLayout);

          for (const option of options) {
            option.checked = option.value === storedLayout;
          }
        }
      }
    })();
  </script>
{% endunless %}

{% stylesheet %}
  .product-grid {
    --product-grid-gap: var(--product-grid-gap-mobile);
    --mobile-columns: 2; /* Default value */

    isolation: isolate;

    @media screen and (min-width: 750px) {
      --product-grid-gap: var(--product-grid-gap-desktop);
    }
  }


  .product-grid slideshow-arrows .slideshow-control {
    display: none;

    @media screen and (min-width: 750px) {
      display: grid;
    }
  }

  /* This triggers iOS < 16.4 */
  @supports not (background-color: rgb(from red 150 g b / alpha)) {
    /* Force aspect ratio to auto for iOS < 16.4 since it's not compatible with the infinite pagination */
    .product-grid .product-media,
    .product-grid .product-media-container {
      aspect-ratio: auto;
    }
  }

  .main-collection-grid {
    padding: var(--grid--margin--mobile);

    @media screen and (min-width: 750px) {
      padding: var(--padding-block-start) var(--padding-inline-end) var(--padding-block-end) var(--padding-inline-start);
    }
  }

  .ResultsList{ 
    @media screen and (max-width: 750px) {
    margin-left: 25px;
    }
  }

  .main-collection-grid__empty {
    padding-block: var(--padding-6xl);
    padding-inline: var(--page-margin);
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    gap: var(--padding-sm);
  }

  .main-collection-grid__empty-title {
    margin: 0;
  }

  .collection-wrapper--full-width .main-collection-grid__title {
    margin-left: var(--page-margin);
  }

  .collection-wrapper--full-width-on-mobile .main-collection-grid__title {
    @media screen and (max-width: 749px) {
      margin-left: var(--page-margin);
    }
  }
{% endstylesheet %}
