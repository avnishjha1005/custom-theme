
{%- doc -%}
  Renders a quick add component as a block in product card groups.

  @param {object} product - The product object (from closest.product)
  @param {string} section_id - The section ID
{%- enddoc -%}

{% liquid
  assign product = closest.product
  unless product == blank
    assign product_form_id = 'QuickAdd-ProductForm-' | append: product.id | append: '-' | append: block.id
    assign add_to_cart_text = 'actions.add' | t

    # Logic to determine which variant to use (matching swatch selection logic from product-card)
    assign variant_to_use = product.selected_or_first_available_variant
    assign combined_listing_count = product.options_with_values | map: 'values' | map: 'product_url' | compact | size

    unless combined_listing_count > 0
      assign first_image = product.media.first
      assign variant_images = product.images | where: 'attached_to_variant?', true
      # Get swatchable options (options that have swatch values)
      assign swatch_variant_picker = null
      for option in product.options_with_values
        assign swatch_count = option.values | map: 'swatch' | compact | size
        if swatch_count > 0
          assign swatch_variant_picker = option
          break
        endif
      endfor

      if swatch_variant_picker
        assign swatch_count = swatch_variant_picker.values | map: 'swatch' | compact | size

        if swatch_count == 1
          # Single swatch: use that variant
          assign variant_to_use = swatch_variant_picker.values.first.variant
        elsif swatch_count > 1
          if first_image and variant_images contains first_image
            # First image is a variant image - find which variant it belongs to
            for option_value in swatch_variant_picker.values
              if option_value.variant.featured_media.id == first_image.id
                assign variant_to_use = option_value.variant
                break
              endif
            endfor
          elsif variant_images.size == 0
            # No variants have images - use first swatch variant
            assign variant_to_use = swatch_variant_picker.values.first.variant
          endif
          # else: First image is NOT a variant image - keep default (selected_or_first_available_variant)
        endif
      endif
    endunless

    if variant_to_use.available
      assign can_add_to_cart = true
    else
      assign can_add_to_cart = false
    endif
  endunless
%}

{% unless product == blank %}
  <div
    class="product-card-quick-add-block spacing-style"
    style="{% render 'spacing-style', settings: block.settings %}"
    {{ block.shopify_attributes }}
  >
    <quick-add-component
      class="quick-add {% if settings.quick_add_color_scheme %}color-{{ settings.quick_add_color_scheme }}{% endif %} quick-add--inline"
      ref="quickAdd"
      data-product-title="{{ product.title }}"
    >
      <product-form-component
        data-section-id="{{ section.id }}"
        data-product-id="{{ product.id }}"
        on:submit="/handleSubmit"
        class="
          quick-add__product-form-component
          {% if product.options.size == 1 %} quick-add__product-form-component--single-option {% else %} quick-add__product-form-component--multi-option {% endif %}
          {% if product.variants.size == 1 %} quick-add__product-form-component--single-variant {% else %} quick-add__product-form-component--multi-variant {% endif %}
        "
      >
        <div
          class="visually-hidden"
          aria-live="assertive"
          role="status"
          aria-atomic="true"
          ref="liveRegion"
        ></div>
        {%- form 'product', product, id: product_form_id, novalidate: 'novalidate', data-type: 'add-to-cart-form' -%}
          <input
            type="hidden"
            name="id"
            ref="variantId"
            value="{{ variant_to_use.id }}"
            {% if variant_to_use.available == false %}
              disabled
            {% endif %}
          >
          <input
            type="hidden"
            name="quantity"
            value="{% if variant_to_use.quantity_rule.min %}{{ variant_to_use.quantity_rule.min }}{% else %}1{% endif %}"
          >
          {% comment %} If there is one variant option but it's swatches or if it's a single variant product, then use add to cart button {% endcomment %}
          {%- if product.variants.size == 1 or product.options.size == 1 -%}
            {% render 'add-to-cart-button',
              add_to_cart_text: add_to_cart_text,
              class: 'button quick-add__button quick-add__button--add',
              can_add_to_cart: can_add_to_cart,
              icon_only_on_mobile: true,
              product: product
            %}
          {%- endif -%}
          {%- if product.variants.size > 1 -%}
            <button
              class="button quick-add__button quick-add__button--choose"
              {% comment %} type="submit" is the default, so we explicitly set it to "button" to prevent the ProductFormComponent.handleSubmit from being triggered {% endcomment %}
              type="button"
              name="add"
              on:click="quick-add-component/handleClick"
            >
              <span
                class="add-to-cart-text"
              >
                <span
                  class="svg-wrapper add-to-cart-icon"
                >
                  {{- 'icon-add-to-cart.svg' -}}
                </span>
              </span>
            </button>
          {%- endif -%}
        {%- endform -%}
      </product-form-component>
    </quick-add-component>
  </div>
{% endunless %}

{% stylesheet %}
  /* Quick Add Block - Inline version */
  .product-card-quick-add-block {
    display: flex;
    align-items: center;
  }

  .quick-add--inline {
    position: static;
    display: flex;
    flex-direction: row;
    justify-content: flex-end;
    align-items: center;
    width: 100%;
    inset: auto;
    pointer-events: auto;
  }

  .quick-add--inline .quick-add__button {
    display: grid;
    position: relative;
    pointer-events: all;
  }

  .quick-add--inline .quick-add__button .add-to-cart-text__content {
    width: fit-content;
    opacity: 1;
    transform: translateX(0);
  }
{% endstylesheet %}

{% schema %}
{
  "name": "Quick Add",
  "tag": null,
  "settings": [
    {
      "type": "header",
      "content": "t:content.padding"
    },
    {
      "type": "range",
      "id": "padding-block-start",
      "label": "t:settings.top",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "label": "t:settings.bottom",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-inline-start",
      "label": "t:settings.left",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-inline-end",
      "label": "t:settings.right",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    }
  ],
  "presets": [
    {
      "name": "t:names.quick_add",
      "category": "t:categories.product"
    }
  ]
}
{% endschema %}

