{%- liquid
  assign button_class = 'wishlist-button'
  if block.settings.position
    assign button_class = button_class | append: ' wishlist-button--' | append: block.settings.position
  endif
  if block.settings.show_background
    assign button_class = button_class | append: ' wishlist-button--with-bg'
  endif

  assign target_product = product | default: card_product
-%}

{%- comment -%} 
  This block only outputs the CSS and JS once, but it works for every instance 
  because it defines a global "Template" for the wishlist behavior.
{%- endcomment -%}
{%- unless wishlist_script_printed -%}
  <style>
  wishlist-button {
    display: inline-block;
    position: absolute;
    z-index: 20;
    line-height: 0;
  }

  .wishlist-button {
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border: none;
    background: none;
    padding: 0;
    margin: 0;
    transition: transform 0.2s ease;
  }

  .wishlist-button--with-bg {
    background: var(--wl-bg);
    border-radius: var(--wl-radius);
    padding: var(--wl-padding);
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }

  .wishlist-button--top-left { top: 10px; left: 10px; }
  .wishlist-button--top-right { top: 10px; right: 10px; }
  .wishlist-button--bottom-left { bottom: 10px; left: 10px; }
  .wishlist-button--bottom-right { bottom: 10px; right: 10px; }

  .wishlist-icon {
    width: var(--wl-size);
    height: var(--wl-size);
    color: var(--wl-color);
  }

  .wishlist-icon--filled { display: none; }
  .wishlist-button--active .wishlist-icon--outline { display: none; }
  .wishlist-button--active .wishlist-icon--filled {
    display: block;
    color: var(--wl-color-active);
  }

  .wishlist-button:hover { transform: scale(1.1); }
</style>
<script>
  console.log('[Wishlist] script loaded');

  if (!window.WishlistInit) {
    window.WishlistInit = true;

    const getList = () =>
      JSON.parse(localStorage.getItem('shopify-wishlist') || '[]');

    const saveList = list => {
      localStorage.setItem('shopify-wishlist', JSON.stringify(list));
      window.dispatchEvent(new Event('wishlist:updated'));
    };

    const initButton = el => {
      if (el.__wishlistReady) return;
      el.__wishlistReady = true;

      const button = el.querySelector('button');
      if (!button) return;

      const id = String(el.dataset.id);

      const refresh = () => {
        const active = getList().some(i => i.id === id);
        button.classList.toggle('wishlist-button--active', active);
      };

      button.addEventListener('click', e => {
        e.preventDefault();
        e.stopPropagation();

        let list = getList();
        const index = list.findIndex(i => i.id === id);

        if (index > -1) {
          list.splice(index, 1);
        } else {
          list.push({
            id,
            title: el.dataset.title,
            handle: el.dataset.handle,
            image: el.dataset.img
          });
        }

        saveList(list);
      });

      refresh();
      window.addEventListener('wishlist:updated', refresh);
    };

    const scan = () =>
      document.querySelectorAll('wishlist-button').forEach(initButton);

    scan();

    new MutationObserver(scan).observe(document.body, {
      childList: true,
      subtree: true
    });
  }
</script>


  {%- assign wishlist_script_printed = true -%}
{%- endunless -%}

<wishlist-button 
  data-id="{{ target_product.id }}"
  data-title="{{ target_product.title | escape }}"
  data-handle="{{ target_product.handle }}"
  data-img="{{ target_product.featured_image | image_url: width: 300 }}"
  class="wishlist-button-container"
>
  <button
    type="button"
    class="{{ button_class }}"
    style="
      --wl-size: {{ block.settings.icon_size }}px;
      --wl-color: {{ block.settings.icon_color }};
      --wl-color-active: {{ block.settings.icon_color_active }};
      --wl-bg: {{ block.settings.background_color }};
      --wl-radius: {{ block.settings.corner_radius }}px;
      --wl-padding: {{ block.settings.padding }}px;
    "
  >
    <svg class="wishlist-icon wishlist-icon--outline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
       <path d="M16.5 3c-1.74 0-3.41.81-4.5 2.09C10.91 3.81 9.24 3 7.5 3 4.42 3 2 5.42 2 8.5c0 3.78 3.4 6.86 8.55 11.54L12 21.35l1.45-1.32C18.6 15.36 22 12.28 22 8.5 22 5.42 19.58 3 16.5 3zm-4.4 15.55l-.1.1-.1-.1C7.14 14.24 4 11.39 4 8.5 4 6.5 5.5 5 7.5 5c1.54 0 3.04.99 3.57 2.36h1.87C13.46 5.99 14.96 5 16.5 5c2 0 3.5 1.5 3.5 3.5 0 2.89-3.14 5.74-7.9 10.05z"/>
    </svg>
    <svg class="wishlist-icon wishlist-icon--filled" viewBox="0 0 24 24">
       <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" fill="currentColor"/>
    </svg>
  </button>
</wishlist-button>

{% schema %}
{
  "name": "Wishlist Button",
  "settings": [
    { "type": "select", "id": "position", "label": "Position", "options": [
        { "value": "top-left", "label": "Top Left" },
        { "value": "top-right", "label": "Top Right" },
        { "value": "bottom-left", "label": "Bottom Left" },
        { "value": "bottom-right", "label": "Bottom Right" }
      ], "default": "top-right" },
    { "type": "range", "id": "icon_size", "label": "Icon Size", "min": 10, "max": 50, "default": 24 },
    { "type": "color", "id": "icon_color", "label": "Icon Color", "default": "#000000" },
    { "type": "color", "id": "icon_color_active", "label": "Icon Color (Active)", "default": "#ff0000" },
    { "type": "checkbox", "id": "show_background", "label": "Show Background", "default": true },
    { "type": "color", "id": "background_color", "label": "Background Color", "default": "#ffffff" },
    { "type": "range", "id": "corner_radius", "label": "Corner Radius", "min": 0, "max": 50, "default": 50 },
    { "type": "range", "id": "padding", "label": "Padding", "min": 0, "max": 20, "default": 8 }
  ],
  "presets": [{ "name": "Wishlist Button" }]
}
{% endschema %}