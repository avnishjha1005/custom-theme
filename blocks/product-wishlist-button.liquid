{%- liquid
  assign in_wishlist = false
  if customer and block.settings.require_login
    # Check if product is in customer wishlist (implement your wishlist logic here)
    # assign in_wishlist = customer.metafields.wishlist.products contains product.id
  endif

  assign button_class = 'wishlist-button'
  if block.settings.position
    assign button_class = button_class | append: ' wishlist-button--' | append: block.settings.position
  endif
  if block.settings.show_background
    assign button_class = button_class | append: ' wishlist-button--with-bg'
  endif
  if in_wishlist
    assign button_class = button_class | append: ' wishlist-button--active'
  endif
-%}

<button
  type="button"
  class="{{ button_class }}"
  data-wishlist-button
  data-product-id="{{ product.id }}"
  data-product-handle="{{ product.handle }}"
  aria-label="{% if in_wishlist %}{{ block.settings.aria_label_remove }}{% else %}{{ block.settings.aria_label_add }}{% endif %}"
  aria-pressed="{{ in_wishlist }}"
  {% if block.settings.require_login and customer == null %}
    data-require-login="true"
  {% endif %}
  style="
    --wishlist-icon-size: {{ block.settings.icon_size }}px;
    --wishlist-icon-color: {{ block.settings.icon_color }};
    --wishlist-icon-color-active: {{ block.settings.icon_color_active }};
    {% if block.settings.show_background %}
      --wishlist-bg-color: {{ block.settings.background_color }};
      --wishlist-corner-radius: {{ block.settings.corner_radius }}px;
      --wishlist-padding: {{ block.settings.padding }}px;
    {% endif %}
  "
>
  
    <svg class="wishlist-icon wishlist-icon--filled" width="{{ block.settings.icon_size }}" height="{{ block.settings.icon_size }}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <span class="svg-wrapper">
        {{- 'icon-wishlist.svg' | inline_asset_content -}}
      </span>
    </svg>
  

  {%- if block.settings.button_style == 'icon-text' -%}
    <span class="wishlist-text">
      <span class="wishlist-text--add">{{ block.settings.add_text }}</span>
      <span class="wishlist-text--remove">{{ block.settings.remove_text }}</span>
    </span>
  {%- endif -%}

  {% comment %} {%- if block.settings.tooltip_add != blank or block.settings.tooltip_remove != blank -%}
    <span class="wishlist-tooltip" role="tooltip">
      <span class="wishlist-tooltip--add">{{ block.settings.tooltip_add }}</span>
      <span class="wishlist-tooltip--remove">{{ block.settings.tooltip_remove }}</span>
    </span>
  {%- endif -%} {% endcomment %}
</button>
 <script>
   // Wishlist feature: Add or remove the current product from the wishlist
    function toggleWishlist() {
        const pdpData = {
            productTitle: "{{ product.title }}",
            productImg: "{{ product.featured_image | img_url: '' }}",
            productPrice: "{{ product.price | money | remove_first: '' }}",
            productUrl: "{{ product.url }}"
        };

        let wishlistData = JSON.parse(localStorage.getItem('wishlist')) || [];
        const isAlreadyInWishlist = wishlistData.some(item => item.productTitle === pdpData.productTitle);
        const wishlistButton = document.getElementsByClassName('wishlist_button')[0];

        if (!isAlreadyInWishlist) {
            wishlistData.push(pdpData);
            localStorage.setItem('wishlist', JSON.stringify(wishlistData));
            // alert('Product added to wishlist:', pdpData.productTitle);
            wishlistButton.innerHTML = `<svg class="heart-filled" width="35px" height="35px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M19.3 5.71002C18.841 5.24601 18.2943 4.87797 17.6917 4.62731C17.0891 4.37666 16.4426 4.2484 15.79 4.25002C15.1373 4.2484 14.4909 4.37666 13.8883 4.62731C13.2857 4.87797 12.739 5.24601 12.28 5.71002L12 6.00002L11.72 5.72001C10.7917 4.79182 9.53273 4.27037 8.22 4.27037C6.90726 4.27037 5.64829 4.79182 4.72 5.72001C3.80386 6.65466 3.29071 7.91125 3.29071 9.22002C3.29071 10.5288 3.80386 11.7854 4.72 12.72L11.49 19.51C11.6306 19.6505 11.8212 19.7294 12.02 19.7294C12.2187 19.7294 12.4094 19.6505 12.55 19.51L19.32 12.72C20.2365 11.7823 20.7479 10.5221 20.7442 9.21092C20.7405 7.89973 20.2218 6.64248 19.3 5.71002Z" fill="#000000"/>
</svg>
<p class="wishlist_text">In Your Wishlist</p>
`;
        } else {
            wishlistData = wishlistData.filter(item => item.productTitle !== pdpData.productTitle);
            localStorage.setItem('wishlist', JSON.stringify(wishlistData));
            // alert('Product removed from wishlist:', pdpData.productTitle);
            wishlistButton.innerHTML = `<svg class="heart-outline" width="40px" height="40px" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">

<rect x="0" fill="none" width="24" height="24"/>

<g>

<path d="M16.5 4.5c2.206 0 4 1.794 4 4 0 4.67-5.543 8.94-8.5 11.023C9.043 17.44 3.5 13.17 3.5 8.5c0-2.206 1.794-4 4-4 1.298 0 2.522.638 3.273 1.706L12 7.953l1.227-1.746c.75-1.07 1.975-1.707 3.273-1.707m0-1.5c-1.862 0-3.505.928-4.5 2.344C11.005 3.928 9.362 3 7.5 3 4.462 3 2 5.462 2 8.5c0 5.72 6.5 10.438 10 12.85 3.5-2.412 10-7.13 10-12.85C22 5.462 19.538 3 16.5 3z"/>

</g>

</svg>
<p class="wishlist_text">Not In Wishlist</p>
`;
        }

        // Update the display after modifying the wishlist
        displayWishlist();
    }


    // Remove the specified product from the wishlist
    function removeFromWishlist(productTitle) {
        let wishlistData = JSON.parse(localStorage.getItem('wishlist')) || [];
        wishlistData = wishlistData.filter(item => item.productTitle !== productTitle);
        localStorage.setItem('wishlist', JSON.stringify(wishlistData));
        // Update the display after removing from the wishlist
        displayWishlist(pdpData);
    }

    // Display wishlist items
    function displayWishlist(pdpData) {
        const wishlistData = JSON.parse(localStorage.getItem('wishlist')) || [];
        
        if (wishlistData.length === 0) {
            console.log('Wishlist is empty');
            return;
        }

        const wishlistHtml = wishlistData.map(item => `
            <div class="wishlist-product__list">
                <div class="c-product">
                <a href="${item.productUrl}">
                    <img src="${item.productImg}" alt="${item.productTitle}">
                    </a>
                    <h3 class="c-product__title card__heading h5">
                        <a class="full-unstyled-link" href="${item.productUrl}">${item.productTitle}</a>
                    </h3>
                    <p>${item.productPrice}</p>
      {% comment %}<button onclick="removeFromWishlist('${item.productTitle}')">Remove</button> {% endcomment %}
                </div>
            </div>
        `).join('');

        const wishlistBlock = document.querySelector('.js-wishlistBlock');

        // Add a check to ensure the element is not null before setting innerHTML
        if (wishlistBlock) {
            wishlistBlock.innerHTML = wishlistHtml;
        } else {
            console.error('Element with class "js-wishlistBlock" not found');
        }
    }

   // Execute this function on DOM content load
document.addEventListener('DOMContentLoaded', function () {
    // Fetch the wishlist data from localStorage
    const wishlistData = JSON.parse(localStorage.getItem('wishlist')) || [];

    // Set the initial button text based on whether the product is in the wishlist or not
    const wishlistButton = document.querySelector('.wishlist_button'); // Use querySelector instead of getElementsByClassName
    const productTitle = "{{ product.title }}";
    
    if (wishlistButton) {
        const isAlreadyInWishlist = wishlistData.some(item => item.productTitle === productTitle);
        wishlistButton.innerHTML = isAlreadyInWishlist ? `<svg class="heart-filled" width="35px" height="35px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M19.3 5.71002C18.841 5.24601 18.2943 4.87797 17.6917 4.62731C17.0891 4.37666 16.4426 4.2484 15.79 4.25002C15.1373 4.2484 14.4909 4.37666 13.8883 4.62731C13.2857 4.87797 12.739 5.24601 12.28 5.71002L12 6.00002L11.72 5.72001C10.7917 4.79182 9.53273 4.27037 8.22 4.27037C6.90726 4.27037 5.64829 4.79182 4.72 5.72001C3.80386 6.65466 3.29071 7.91125 3.29071 9.22002C3.29071 10.5288 3.80386 11.7854 4.72 12.72L11.49 19.51C11.6306 19.6505 11.8212 19.7294 12.02 19.7294C12.2187 19.7294 12.4094 19.6505 12.55 19.51L19.32 12.72C20.2365 11.7823 20.7479 10.5221 20.7442 9.21092C20.7405 7.89973 20.2218 6.64248 19.3 5.71002Z" fill="#000000"/>
</svg> <p class="wishlist_text">In Your Wishlist</p>` : `<svg width="35px" height="35px" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="heart-outline">

<rect x="0" fill="none" width="24" height="24"/>

<g>

<path d="M16.5 4.5c2.206 0 4 1.794 4 4 0 4.67-5.543 8.94-8.5 11.023C9.043 17.44 3.5 13.17 3.5 8.5c0-2.206 1.794-4 4-4 1.298 0 2.522.638 3.273 1.706L12 7.953l1.227-1.746c.75-1.07 1.975-1.707 3.273-1.707m0-1.5c-1.862 0-3.505.928-4.5 2.344C11.005 3.928 9.362 3 7.5 3 4.462 3 2 5.462 2 8.5c0 5.72 6.5 10.438 10 12.85 3.5-2.412 10-7.13 10-12.85C22 5.462 19.538 3 16.5 3z"/>

</g>

</svg>
<p class="wishlist_text">Not In Wishlist</p>
`;
    } else {
        console.error('Element with class "wishlist_button" not found');
    }

    // Display wishlist items
    displayWishlist();
});
    </script>

<style>
  .wishlist-button {
    position: absolute;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    border: none;
    cursor: pointer;
    background: transparent;
    transition: transform 0.2s ease;
    z-index: 10;
  }

  .wishlist-button--with-bg {
    background: var(--wishlist-bg-color);
    border-radius: var(--wishlist-corner-radius);
    padding: var(--wishlist-padding);
  }

  .wishlist-button--top-left {
    top: 0.75rem;
    left: 0.75rem;
  }

  .wishlist-button--top-right {
    top: 0.75rem;
    right: 0.75rem;
  }

  .wishlist-button--bottom-left {
    bottom: 0.75rem;
    left: 0.75rem;
  }

  .wishlist-button--bottom-right {
    bottom: 0.75rem;
    right: 0.75rem;
  }

  .wishlist-icon {
    width: var(--wishlist-icon-size);
    height: var(--wishlist-icon-size);
    color: var(--wishlist-icon-color);
    transition: color 0.2s ease, transform 0.2s ease;
  }

  .wishlist-button--active .wishlist-icon {
    color: var(--wishlist-icon-color-active);
  }

  .wishlist-button:hover {
    transform: scale(1.1);
  }

  {% if block.settings.enable_animation %}
    @keyframes wishlist-scale {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.3); }
    }

    @keyframes wishlist-bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
    }

    @keyframes wishlist-pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    .wishlist-button--active .wishlist-icon {
      animation: wishlist-{{ block.settings.animation_type }} 0.4s ease;
    }
  {% endif %}

  .wishlist-text {
    font-size: 0.875rem;
    white-space: nowrap;
  }

  .wishlist-text--remove {
    display: none;
  }

  .wishlist-button--active .wishlist-text--add {
    display: none;
  }

  .wishlist-button--active .wishlist-text--remove {
    display: inline;
  }

  .wishlist-tooltip {
    position: absolute;
    bottom: calc(100% + 0.5rem);
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 0.375rem 0.75rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    white-space: nowrap;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s ease;
  }

  .wishlist-button:hover .wishlist-tooltip {
    opacity: 1;
  }

  .wishlist-tooltip--remove {
    display: none;
  }

  .wishlist-button--active .wishlist-tooltip--add {
    display: none;
  }

  .wishlist-button--active .wishlist-tooltip--remove {
    display: inline;
  }
</style>

<script>
  if (!customElements.get('wishlist-button')) {
    class WishlistButton extends HTMLElement {
      constructor() {
        super();
        this.button = this.querySelector('[data-wishlist-button]');
        this.productId = this.button?.dataset.productId;
        this.productHandle = this.button?.dataset.productHandle;
        this.requireLogin = this.button?.dataset.requireLogin === 'true';
        
        this.button?.addEventListener('click', this.handleClick.bind(this));
      }

      async handleClick(e) {
        e.preventDefault();
        e.stopPropagation();

        // Check if login is required
        if (this.requireLogin && !window.Shopify?.customer) {
          window.location.href = '/account/login';
          return;
        }

        const isActive = this.button.classList.contains('wishlist-button--active');
        
        try {
          // Toggle wishlist state (implement your wishlist logic here)
          if (isActive) {
            await this.removeFromWishlist();
          } else {
            await this.addToWishlist();
          }

          // Toggle UI state
          this.button.classList.toggle('wishlist-button--active');
          this.button.setAttribute('aria-pressed', !isActive);

          // Show notification if enabled
          {% if block.settings.show_notification %}
          this.showNotification(isActive ? 'removed' : 'added');
          {% endif %}

          // Dispatch custom event
          this.dispatchEvent(new CustomEvent('wishlist:toggle', {
            bubbles: true,
            detail: { productId: this.productId, inWishlist: !isActive }
          }));
        } catch (error) {
          console.error('Wishlist error:', error);
        }
      }

      async addToWishlist() {
        // Implement your add to wishlist logic
        // Example: API call, localStorage, customer metafields, etc.
        console.log('Adding to wishlist:', this.productId);
      }

      async removeFromWishlist() {
        // Implement your remove from wishlist logic
        console.log('Removing from wishlist:', this.productId);
      }

      showNotification(action) {
        // Implement notification display
        const message = action === 'added' 
          ? '{{ block.settings.add_text }}' 
          : '{{ block.settings.remove_text }}';
        console.log(message);
      }
    }

    customElements.define('wishlist-button', WishlistButton);
  }
</script>

{% schema %}
{
  "name": "Wishlist Button",
  "tag": "wishlist-button",
  "settings": [
    {
      "type": "paragraph",
      "content": "Display a wishlist button on product cards to allow customers to save products"
    },
    {
      "type": "header",
      "content": "t:content.layout"
    },
    {
      "type": "select",
      "id": "position",
      "label": "Position",
      "options": [
        {
          "value": "top-left",
          "label": "Top Left"
        },
        {
          "value": "top-right",
          "label": "Top Right"
        },
        {
          "value": "bottom-left",
          "label": "Bottom Left"
        },
        {
          "value": "bottom-right",
          "label": "Bottom Right"
        }
      ],
      "default": "top-right"
    },
    {
      "type": "select",
      "id": "button_style",
      "label": "Button Style",
      "options": [
        {
          "value": "icon-only",
          "label": "Icon Only"
        },
        {
          "value": "icon-text",
          "label": "Icon with Text"
        }
      ],
      "default": "icon-only"
    },
    {
      "type": "header",
      "content": "Icon Settings"
    },
    {
      "type": "range",
      "id": "icon_size",
      "label": "Icon Size",
      "min": 16,
      "max": 48,
      "step": 2,
      "unit": "px",
      "default": 24
    },
    {
      "type": "select",
      "id": "icon_style",
      "label": "Icon Style",
      "options": [
        {
          "value": "outline",
          "label": "Outline"
        },
        {
          "value": "filled",
          "label": "Filled"
        }
      ],
      "default": "outline"
    },
    {
      "type": "color",
      "id": "icon_color",
      "label": "Icon Color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "icon_color_active",
      "label": "Icon Color (Active)",
      "default": "#ff0000"
    },
    {
      "type": "header",
      "content": "Background"
    },
    {
      "type": "checkbox",
      "id": "show_background",
      "label": "Show Background",
      "default": true
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background Color",
      "alpha": true,
      "default": "#ffffff",
      "visible_if": "{{ block.settings.show_background }}"
    },
    {
      "type": "range",
      "id": "corner_radius",
      "label": "Corner Radius",
      "min": 0,
      "max": 50,
      "step": 1,
      "unit": "px",
      "default": 50,
      "visible_if": "{{ block.settings.show_background }}"
    },
    {
      "type": "header",
      "content": "Animation"
    },
    {
      "type": "checkbox",
      "id": "enable_animation",
      "label": "Enable Animation",
      "default": true,
      "info": "Animate icon when added to wishlist"
    },
    {
      "type": "select",
      "id": "animation_type",
      "label": "Animation Type",
      "options": [
        {
          "value": "scale",
          "label": "Scale"
        },
        {
          "value": "bounce",
          "label": "Bounce"
        },
        {
          "value": "pulse",
          "label": "Pulse"
        }
      ],
      "default": "scale",
      "visible_if": "{{ block.settings.enable_animation }}"
    },
    {
      "type": "header",
      "content": "Button Text"
    },
    {
      "type": "text",
      "id": "add_text",
      "label": "Add to Wishlist Text",
      "default": "Add to Wishlist",
      "visible_if": "{{ block.settings.button_style == 'icon-text' }}"
    },
    {
      "type": "text",
      "id": "remove_text",
      "label": "Remove from Wishlist Text",
      "default": "Remove from Wishlist",
      "visible_if": "{{ block.settings.button_style == 'icon-text' }}"
    },
    {
      "type": "text",
      "id": "tooltip_add",
      "label": "Tooltip - Add",
      "default": "Add to wishlist",
      "info": "Tooltip shown on hover when not in wishlist"
    },
    {
      "type": "text",
      "id": "tooltip_remove",
      "label": "Tooltip - Remove",
      "default": "Remove from wishlist",
      "info": "Tooltip shown on hover when in wishlist"
    },
    {
      "type": "header",
      "content": "Accessibility"
    },
    {
      "type": "text",
      "id": "aria_label_add",
      "label": "ARIA Label - Add",
      "default": "Add to wishlist"
    },
    {
      "type": "text",
      "id": "aria_label_remove",
      "label": "ARIA Label - Remove",
      "default": "Remove from wishlist"
    },
    {
      "type": "header",
      "content": "Behavior"
    },
    {
      "type": "checkbox",
      "id": "require_login",
      "label": "Require Customer Login",
      "default": true,
      "info": "Redirect to login page if customer is not logged in"
    },
    {
      "type": "checkbox",
      "id": "show_notification",
      "label": "Show Notification",
      "default": true,
      "info": "Display a notification when item is added/removed"
    },
    {
      "type": "header",
      "content": "Spacing"
    },
    {
      "type": "range",
      "id": "padding",
      "label": "Button Padding",
      "min": 0,
      "max": 24,
      "step": 2,
      "unit": "px",
      "default": 8,
      "visible_if": "{{ block.settings.show_background }}"
    }
  ],
  "presets": [
    {
      "name": "Wishlist Button",
      "category": "Product"
    }
  ]
}
{% endschema %}