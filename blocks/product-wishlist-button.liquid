{%- liquid
  assign in_wishlist = false
  if customer and block.settings.require_login
    # Check if product is in customer wishlist (implement your wishlist logic here)
    # assign in_wishlist = customer.metafields.wishlist.products contains product.id
  endif

  assign button_class = 'wishlist-button'
  if block.settings.position
    assign button_class = button_class | append: ' wishlist-button--' | append: block.settings.position
  endif
  if block.settings.show_background
    assign button_class = button_class | append: ' wishlist-button--with-bg'
  endif
  if in_wishlist
    assign button_class = button_class | append: ' wishlist-button--active'
  endif
-%}

<button
  type="button"
  class="{{ button_class }}"
  data-wishlist-button
  data-product-id="{{ product.id }}"
  data-product-handle="{{ product.handle }}"
  aria-label="{% if in_wishlist %}{{ block.settings.aria_label_remove }}{% else %}{{ block.settings.aria_label_add }}{% endif %}"
  aria-pressed="{{ in_wishlist }}"
  {% if block.settings.require_login and customer == null %}
    data-require-login="true"
  {% endif %}
  style="
    --wishlist-icon-size: {{ block.settings.icon_size }}px;
    --wishlist-icon-color: {{ block.settings.icon_color }};
    --wishlist-icon-color-active: {{ block.settings.icon_color_active }};
    {% if block.settings.show_background %}
      --wishlist-bg-color: {{ block.settings.background_color }};
      --wishlist-corner-radius: {{ block.settings.corner_radius }}px;
      --wishlist-padding: {{ block.settings.padding }}px;
    {% endif %}
  "
>
  {%- if block.settings.icon_style == 'filled' -%}
    <svg class="wishlist-icon wishlist-icon--filled" width="{{ block.settings.icon_size }}" height="{{ block.settings.icon_size }}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" fill="currentColor"/>
    </svg>
  {%- else -%}
    <svg class="wishlist-icon wishlist-icon--outline" width="{{ block.settings.icon_size }}" height="{{ block.settings.icon_size }}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <path d="M16.5 3C14.76 3 13.09 3.81 12 5.09 10.91 3.81 9.24 3 7.5 3 4.42 3 2 5.42 2 8.5c0 3.78 3.4 6.86 8.55 11.54L12 21.35l1.45-1.32C18.6 15.36 22 12.28 22 8.5 22 5.42 19.58 3 16.5 3zm-4.4 15.55l-.1.1-.1-.1C7.14 14.24 4 11.39 4 8.5 4 6.5 5.5 5 7.5 5c1.54 0 3.04.99 3.57 2.36h1.87C13.46 5.99 14.96 5 16.5 5c2 0 3.5 1.5 3.5 3.5 0 2.89-3.14 5.74-7.9 10.05z" fill="currentColor"/>
    </svg>
  {%- endif -%}

  {%- if block.settings.button_style == 'icon-text' -%}
    <span class="wishlist-text">
      <span class="wishlist-text--add">{{ block.settings.add_text }}</span>
      <span class="wishlist-text--remove">{{ block.settings.remove_text }}</span>
    </span>
  {%- endif -%}

  {% comment %} {%- if block.settings.tooltip_add != blank or block.settings.tooltip_remove != blank -%}
    <span class="wishlist-tooltip" role="tooltip">
      <span class="wishlist-tooltip--add">{{ block.settings.tooltip_add }}</span>
      <span class="wishlist-tooltip--remove">{{ block.settings.tooltip_remove }}</span>
    </span>
  {%- endif -%} {% endcomment %}
</button>

<style>
  .wishlist-button {
    position: absolute;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    border: none;
    cursor: pointer;
    background: transparent;
    transition: transform 0.2s ease;
    z-index: 10;
  }

  .wishlist-button--with-bg {
    background: var(--wishlist-bg-color);
    border-radius: var(--wishlist-corner-radius);
    padding: var(--wishlist-padding);
  }

  .wishlist-button--top-left {
    top: 0.75rem;
    left: 0.75rem;
  }

  .wishlist-button--top-right {
    top: 0.75rem;
    right: 0.75rem;
  }

  .wishlist-button--bottom-left {
    bottom: 0.75rem;
    left: 0.75rem;
  }

  .wishlist-button--bottom-right {
    bottom: 0.75rem;
    right: 0.75rem;
  }

  .wishlist-icon {
    width: var(--wishlist-icon-size);
    height: var(--wishlist-icon-size);
    color: var(--wishlist-icon-color);
    transition: color 0.2s ease, transform 0.2s ease;
  }

  .wishlist-button--active .wishlist-icon {
    color: var(--wishlist-icon-color-active);
  }

  .wishlist-button:hover {
    transform: scale(1.1);
  }

  {% if block.settings.enable_animation %}
    @keyframes wishlist-scale {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.3); }
    }

    @keyframes wishlist-bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
    }

    @keyframes wishlist-pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    .wishlist-button--active .wishlist-icon {
      animation: wishlist-{{ block.settings.animation_type }} 0.4s ease;
    }
  {% endif %}

  .wishlist-text {
    font-size: 0.875rem;
    white-space: nowrap;
  }

  .wishlist-text--remove {
    display: none;
  }

  .wishlist-button--active .wishlist-text--add {
    display: none;
  }

  .wishlist-button--active .wishlist-text--remove {
    display: inline;
  }

  .wishlist-tooltip {
    position: absolute;
    bottom: calc(100% + 0.5rem);
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 0.375rem 0.75rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    white-space: nowrap;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s ease;
  }

  .wishlist-button:hover .wishlist-tooltip {
    opacity: 1;
  }

  .wishlist-tooltip--remove {
    display: none;
  }

  .wishlist-button--active .wishlist-tooltip--add {
    display: none;
  }

  .wishlist-button--active .wishlist-tooltip--remove {
    display: inline;
  }
</style>

<script>
  if (!customElements.get('wishlist-button')) {
    class WishlistButton extends HTMLElement {
      constructor() {
        super();
        this.button = this.querySelector('[data-wishlist-button]');
        this.productId = this.button?.dataset.productId;
        this.productHandle = this.button?.dataset.productHandle;
        this.requireLogin = this.button?.dataset.requireLogin === 'true';
        
        this.button?.addEventListener('click', this.handleClick.bind(this));
      }

      async handleClick(e) {
        e.preventDefault();
        e.stopPropagation();

        // Check if login is required
        if (this.requireLogin && !window.Shopify?.customer) {
          window.location.href = '/account/login';
          return;
        }

        const isActive = this.button.classList.contains('wishlist-button--active');
        
        try {
          // Toggle wishlist state (implement your wishlist logic here)
          if (isActive) {
            await this.removeFromWishlist();
          } else {
            await this.addToWishlist();
          }

          // Toggle UI state
          this.button.classList.toggle('wishlist-button--active');
          this.button.setAttribute('aria-pressed', !isActive);

          // Show notification if enabled
          {% if block.settings.show_notification %}
          this.showNotification(isActive ? 'removed' : 'added');
          {% endif %}

          // Dispatch custom event
          this.dispatchEvent(new CustomEvent('wishlist:toggle', {
            bubbles: true,
            detail: { productId: this.productId, inWishlist: !isActive }
          }));
        } catch (error) {
          console.error('Wishlist error:', error);
        }
      }

      async addToWishlist() {
        // Implement your add to wishlist logic
        // Example: API call, localStorage, customer metafields, etc.
        console.log('Adding to wishlist:', this.productId);
      }

      async removeFromWishlist() {
        // Implement your remove from wishlist logic
        console.log('Removing from wishlist:', this.productId);
      }

      showNotification(action) {
        // Implement notification display
        const message = action === 'added' 
          ? '{{ block.settings.add_text }}' 
          : '{{ block.settings.remove_text }}';
        console.log(message);
      }
    }

    customElements.define('wishlist-button', WishlistButton);
  }
</script>

{% schema %}
{
  "name": "Wishlist Button",
  "tag": "wishlist-button",
  "settings": [
    {
      "type": "paragraph",
      "content": "Display a wishlist button on product cards to allow customers to save products"
    },
    {
      "type": "header",
      "content": "t:content.layout"
    },
    {
      "type": "select",
      "id": "position",
      "label": "Position",
      "options": [
        {
          "value": "top-left",
          "label": "Top Left"
        },
        {
          "value": "top-right",
          "label": "Top Right"
        },
        {
          "value": "bottom-left",
          "label": "Bottom Left"
        },
        {
          "value": "bottom-right",
          "label": "Bottom Right"
        }
      ],
      "default": "top-right"
    },
    {
      "type": "select",
      "id": "button_style",
      "label": "Button Style",
      "options": [
        {
          "value": "icon-only",
          "label": "Icon Only"
        },
        {
          "value": "icon-text",
          "label": "Icon with Text"
        }
      ],
      "default": "icon-only"
    },
    {
      "type": "header",
      "content": "Icon Settings"
    },
    {
      "type": "range",
      "id": "icon_size",
      "label": "Icon Size",
      "min": 16,
      "max": 48,
      "step": 2,
      "unit": "px",
      "default": 24
    },
    {
      "type": "select",
      "id": "icon_style",
      "label": "Icon Style",
      "options": [
        {
          "value": "outline",
          "label": "Outline"
        },
        {
          "value": "filled",
          "label": "Filled"
        }
      ],
      "default": "outline"
    },
    {
      "type": "color",
      "id": "icon_color",
      "label": "Icon Color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "icon_color_active",
      "label": "Icon Color (Active)",
      "default": "#ff0000"
    },
    {
      "type": "header",
      "content": "Background"
    },
    {
      "type": "checkbox",
      "id": "show_background",
      "label": "Show Background",
      "default": true
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background Color",
      "alpha": true,
      "default": "#ffffff",
      "visible_if": "{{ block.settings.show_background }}"
    },
    {
      "type": "range",
      "id": "corner_radius",
      "label": "Corner Radius",
      "min": 0,
      "max": 50,
      "step": 1,
      "unit": "px",
      "default": 50,
      "visible_if": "{{ block.settings.show_background }}"
    },
    {
      "type": "header",
      "content": "Animation"
    },
    {
      "type": "checkbox",
      "id": "enable_animation",
      "label": "Enable Animation",
      "default": true,
      "info": "Animate icon when added to wishlist"
    },
    {
      "type": "select",
      "id": "animation_type",
      "label": "Animation Type",
      "options": [
        {
          "value": "scale",
          "label": "Scale"
        },
        {
          "value": "bounce",
          "label": "Bounce"
        },
        {
          "value": "pulse",
          "label": "Pulse"
        }
      ],
      "default": "scale",
      "visible_if": "{{ block.settings.enable_animation }}"
    },
    {
      "type": "header",
      "content": "Button Text"
    },
    {
      "type": "text",
      "id": "add_text",
      "label": "Add to Wishlist Text",
      "default": "Add to Wishlist",
      "visible_if": "{{ block.settings.button_style == 'icon-text' }}"
    },
    {
      "type": "text",
      "id": "remove_text",
      "label": "Remove from Wishlist Text",
      "default": "Remove from Wishlist",
      "visible_if": "{{ block.settings.button_style == 'icon-text' }}"
    },
    {
      "type": "text",
      "id": "tooltip_add",
      "label": "Tooltip - Add",
      "default": "Add to wishlist",
      "info": "Tooltip shown on hover when not in wishlist"
    },
    {
      "type": "text",
      "id": "tooltip_remove",
      "label": "Tooltip - Remove",
      "default": "Remove from wishlist",
      "info": "Tooltip shown on hover when in wishlist"
    },
    {
      "type": "header",
      "content": "Accessibility"
    },
    {
      "type": "text",
      "id": "aria_label_add",
      "label": "ARIA Label - Add",
      "default": "Add to wishlist"
    },
    {
      "type": "text",
      "id": "aria_label_remove",
      "label": "ARIA Label - Remove",
      "default": "Remove from wishlist"
    },
    {
      "type": "header",
      "content": "Behavior"
    },
    {
      "type": "checkbox",
      "id": "require_login",
      "label": "Require Customer Login",
      "default": true,
      "info": "Redirect to login page if customer is not logged in"
    },
    {
      "type": "checkbox",
      "id": "show_notification",
      "label": "Show Notification",
      "default": true,
      "info": "Display a notification when item is added/removed"
    },
    {
      "type": "header",
      "content": "Spacing"
    },
    {
      "type": "range",
      "id": "padding",
      "label": "Button Padding",
      "min": 0,
      "max": 24,
      "step": 2,
      "unit": "px",
      "default": 8,
      "visible_if": "{{ block.settings.show_background }}"
    }
  ],
  "presets": [
    {
      "name": "Wishlist Button",
      "category": "Product"
    }
  ]
}
{% endschema %}